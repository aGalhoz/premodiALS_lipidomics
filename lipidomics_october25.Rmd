---
title: "Lipidomics analysis - data from October 2025"
author: "Ana Galhoz"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    keep_md: yes
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 5
    theme: lumen
---

## Run Libraries

```{r run-libraries,message=FALSE,warning = FALSE}
rm(list=ls())

library(pheatmap)
library(ggplot2)
library(dichromat)
library(dplyr)
library(ggrepel)
library(reshape2)
library(umap)
library(ggthemes)
library(cowplot)
library(DEP)
library(readr)
library(naniar)
library(SummarizedExperiment)
library(data.table)
library(readxl)
library(writexl)
library(stringr)
library(vsn)
library(rmarkdown)
library(tidyr)
library(Polychrome)
library(RColorBrewer)
library(skimr)
library(rstatix)
# install.packages("devtools")
# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# options(repos = c(
#     CRAN = "https://cloud.r-project.org/",
#     BiocManager::repositories()))
# ## Install dependencies and package
# devtools::install_github(
#     "BioinfOMICS/LipidSigR",
#     build_vignettes = TRUE, dependencies = TRUE)
# BiocManager::install(
#     c('fgsea', 'gatom', 'mixOmics', 'S4Vectors', 'BiocGenerics',
#       'SummarizedExperiment', 'rgoslin'))
# install.packages(
#     c('devtools', 'magrittr', 'plotly', 'tidyverse', 'factoextra', 'ggthemes',
#       'ggforce', 'Hmisc', 'hwordcloud', 'heatmaply', 'iheatmapr', 'Rtsne', 'uwot',
#       'wordcloud', 'rsample', 'ranger', 'caret', 'yardstick', 'fastshap',
#       'SHAPforxgboost', 'visNetwork', 'tidygraph', 'ggraph'))
# devtools::install_github("ctlab/mwcsr")
```

## Set working directories

```{r set-working-directories, message=FALSE, class.source = 'fold-hide'}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

# create directory for results
dir.create(file.path(getwd(),'results'), showWarnings = FALSE)
# create directory for plots
dir.create(file.path(getwd(),'plots'), showWarnings = FALSE)
```

## Load data

Loading data including:

- All templates: information on the tube ID, rack, visit, country, type of fluid, position
- Shipment of all boxes file: information on the patient ID, visit, position
- Raw data: lipidomics expression with info on the tube ID for CSF and Plasma

### Step 1: merge info of all patients

The **first step** is to *merge* the information of the *"All templates"* and *"Shipment of all boxes"* files, and *create 3 datasets* (one for *plasma*, one for *CSF*, one for *urine*) with the information of *Patient ID, Position, Biofluid, Visit, Tube number, Country, Rack and Box*.

```{r load-data-and-wrangling-patient-info, message=F,echo = FALSE}
# -> urine
lipidomics_urine_1 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275399_Urine 1") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack)
lipidomics_urine_2 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275429_Urine 2") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack)
lipidomics_urine_3 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275447_Urine 3") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack)
lipidomics_urine_4 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275464_Urine 4") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Tube_number = if_else(str_length(Tube_number) < 4,
                       str_pad(Tube_number, width = 4, side = "left", pad = "0"),
                       Tube_number))
# -> plasma
lipidomics_plasma_1 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275402_Plasma 1") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Tube_number = if_else(str_length(Tube_number) < 4,
                       str_pad(Tube_number, width = 4, side = "left", pad = "0"),
                       Tube_number))
lipidomics_plasma_2 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275433_Plasma 2") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack) 
lipidomics_plasma_3 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275446_Plasma 3") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack)
lipidomics_plasma_4 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275463_Plasma 4") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Tube_number = if_else(str_length(Tube_number) < 4,
                       str_pad(Tube_number, width = 4, side = "left", pad = "0"),
                       Tube_number))
# -> CSF
lipidomics_CSF_1 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275415_CSF 1") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack)
lipidomics_CSF_2 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275414_CSF 2") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack)
lipidomics_CSF_3 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275444_CSF 3") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack)
lipidomics_CSF_4 = read_excel("data input/all_templates_Slovakia.xlsx", 
    sheet = "Rack_5500275459_CSF 4") %>%
  mutate(Position = paste0(`Tube Row`,`Tube Column`)) %>%
  dplyr::rename(Rack = `CRYOBOX Barcode`,
         Tube_number = `Tube Barcode`,
         Visit = VISIT,
         Country = SITE,
         Biofluid = MATERIAL) %>%
  select(Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Tube_number = if_else(str_length(Tube_number) < 4,
                       str_pad(Tube_number, width = 4, side = "left", pad = "0"),
                       Tube_number))

# get patient ID per box, position and visit
info_patientID_1 =  read_excel("data input/premodiALS shipment all boxes list for omics analyses-2.xlsx", 
    sheet = "Box1") %>%
  dplyr::rename(Comment = `...13`,
         Patient = `Patient ID`) %>%
  select(Patient,Position,Visit,Comment)
info_patientID_2 =  read_excel("data input/premodiALS shipment all boxes list for omics analyses-2.xlsx", 
    sheet = "Box2") %>%
  dplyr::rename(Comment = `...13`,
         Patient = `Patient ID`) %>%
  select(Patient,Position,Visit,Comment)
info_patientID_3 =  read_excel("data input/premodiALS shipment all boxes list for omics analyses-2.xlsx", 
    sheet = "Box3") %>%
  dplyr::rename(Comment = `...13`,
         Patient = `Patient ID`) %>%
  select(Patient,Position,Visit,Comment)
info_patientID_4 =  read_excel("data input/premodiALS shipment all boxes list for omics analyses-2.xlsx", 
    sheet = "Box4") %>%
  dplyr::rename(Comment = `...13`,
         Patient = `Patient ID`) %>%
  select(Patient,Position,Visit,Comment)
info_patientID_4_aux =  read_excel("data input/premodiALS shipment all boxes list for omics analyses-2.xlsx", 
    sheet = "unscanned") 
colnames(info_patientID_4_aux) = c("Patient","Position","Biofluid","Visit",
                                   "Tube_nr","Country","Rack")
info_patientID_4_aux <- info_patientID_4_aux %>%
  mutate(Tube_nr = if_else(str_length(Tube_nr) < 4,
                       str_pad(Tube_nr, width = 4, side = "left", pad = "0"),
                       Tube_nr))

# make sumarised data of  patient IDs, biofluid type,  tube IDs, visit, rack and box number
# CSF
lipidomics_CSF_1 <- lipidomics_CSF_1 %>% left_join(info_patientID_1) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 1")
lipidomics_CSF_2 <- lipidomics_CSF_2 %>% left_join(info_patientID_2) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 2")
lipidomics_CSF_3 <- lipidomics_CSF_3 %>% left_join(info_patientID_3) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 3")
lipidomics_CSF_4_aux1 <- lipidomics_CSF_4 %>% left_join(info_patientID_4) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 4")
lipidomics_CSF_4_aux2 <- lipidomics_CSF_4 %>% 
  select(-Country) %>%
  left_join(info_patientID_4_aux %>% select(Tube_nr,Position,Patient,Biofluid,Visit,Country) %>%
              mutate(Tube_nr = ifelse(Tube_nr == "nothing",NA,Tube_nr))) %>%
  mutate(Tube_number = ifelse(!is.na(Tube_nr),Tube_nr,Tube_number)) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 4") %>%
  distinct() %>%
  arrange(desc(Country))
lipidomics_CSF_4_aux2 =  lipidomics_CSF_4_aux2[!duplicated(lipidomics_CSF_4_aux2$Patient) | is.na(lipidomics_CSF_4_aux2$Patient),]
lipidomics_CSF_4 = rbind(lipidomics_CSF_4_aux1,
                         lipidomics_CSF_4_aux2) %>%
  arrange(str_extract(Position, "[A-Z]"), as.numeric(str_extract(Position, "\\d+"))) %>%
  distinct() %>%
  group_by(Position,Visit) %>%
  filter(!(any(!is.na(Patient)) & is.na(Patient))) %>%
  ungroup()
lipidomics_CSF_all = do.call("rbind",list(lipidomics_CSF_1,
                                          lipidomics_CSF_2,
                                          lipidomics_CSF_3,
                                          lipidomics_CSF_4))
# Plasma
lipidomics_plasma_1 <- lipidomics_plasma_1 %>% left_join(info_patientID_1) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 1")
lipidomics_plasma_2 <- lipidomics_plasma_2 %>% left_join(info_patientID_2) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 2")
lipidomics_plasma_3 <- lipidomics_plasma_3 %>% left_join(info_patientID_3) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 3")
lipidomics_plasma_4_aux1 <- lipidomics_plasma_4 %>% left_join(info_patientID_4) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 4")
lipidomics_plasma_4_aux2 <- lipidomics_plasma_4 %>% 
  select(-Country) %>%
  left_join(info_patientID_4_aux %>% select(Tube_nr,Position,Patient,Biofluid,Visit,Country) %>%
              mutate(Tube_nr = ifelse(Tube_nr == "nothing",NA,Tube_nr),
                     Biofluid = ifelse(Biofluid == "Plasma","plasma",Biofluid))) %>%
  mutate(Tube_number = ifelse(!is.na(Tube_nr),Tube_nr,Tube_number)) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 4") %>%
  distinct() %>%
  arrange(desc(Country))
lipidomics_plasma_4_aux2 =  lipidomics_plasma_4_aux2[!duplicated(lipidomics_plasma_4_aux2$Patient) | is.na(lipidomics_plasma_4_aux2$Patient),]
lipidomics_plasma_4 = rbind(lipidomics_plasma_4_aux1,
                         lipidomics_plasma_4_aux2) %>%
  arrange(str_extract(Position, "[A-Z]"), as.numeric(str_extract(Position, "\\d+"))) %>%
  distinct() %>%
  group_by(Position,Visit) %>%
  filter(!(any(!is.na(Patient)) & is.na(Patient))) %>%
  ungroup()
lipidomics_plasma_all = do.call("rbind",list(lipidomics_plasma_1,
                                          lipidomics_plasma_2,
                                          lipidomics_plasma_3,
                                          lipidomics_plasma_4))
# Urine
lipidomics_urine_1 <- lipidomics_urine_1 %>% left_join(info_patientID_1) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 1")
lipidomics_urine_2 <- lipidomics_urine_2 %>% left_join(info_patientID_2) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 2")
lipidomics_urine_3 <- lipidomics_urine_3 %>% left_join(info_patientID_3) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 3")
lipidomics_urine_4_aux1 <- lipidomics_urine_4 %>% left_join(info_patientID_4) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 4")
lipidomics_urine_4_aux2 <- lipidomics_urine_4 %>% 
  left_join(info_patientID_4_aux %>% dplyr::select(Tube_nr,Position,Patient,Biofluid,Visit) %>%
              mutate(Tube_nr = ifelse(Tube_nr == "nothing",NA,Tube_nr),
                     Biofluid = ifelse(Biofluid == "Urine","urine",Biofluid))) %>%
  mutate(Tube_number = ifelse(!is.na(Tube_nr),Tube_nr,Tube_number)) %>%
  select(Patient,Position,Biofluid,Visit,Tube_number,Country,Rack) %>%
  mutate(Box = "Box 4") %>%
  distinct() %>%
  arrange(desc(Country))
lipidomics_urine_4_aux2 =  lipidomics_urine_4_aux2[!duplicated(lipidomics_urine_4_aux2$Patient) | is.na(lipidomics_urine_4_aux2$Patient),]
lipidomics_urine_4 = rbind(lipidomics_urine_4_aux1,
                         lipidomics_urine_4_aux2) %>%
  arrange(str_extract(Position, "[A-Z]"), as.numeric(str_extract(Position, "\\d+"))) %>%
  distinct() %>%
  group_by(Position,Visit) %>%
  filter(!(any(!is.na(Patient)) & is.na(Patient))) %>%
  ungroup()
lipidomics_urine_all = do.call("rbind",list(lipidomics_urine_1,
                                          lipidomics_urine_2,
                                          lipidomics_urine_3,
                                          lipidomics_urine_4))

# get raw data
# -> CSF
raw_data_CSF_1 =  read_excel("data input/Premodials_CSF_Areas.xlsx", 
    sheet = "2025-08-05 Premodials_Batch1") 
raw_data_CSF_2 = read_excel("data input/Premodials_CSF_Areas.xlsx", 
    sheet = "2025-08-06 Predmodials_Batch2")
raw_data_CSF_3 = read_excel("data input/Premodials_CSF_Areas.xlsx", 
    sheet = "2025-08-07 Predmodials_Batch3")
raw_data_CSF <- do.call("rbind",list(raw_data_CSF_1,
                                     raw_data_CSF_2,
                                     raw_data_CSF_3)) %>%
  mutate(Tube_number = str_extract(`Sample Name`, "(?<=_)\\d+(?=_)"),
         Batch = paste0("Batch ",str_extract(`Sample Name`,"(?<=_)(\\d+)$")),
         Tube_number = if_else(str_starts(`Sample Name`,"QC_"),
                               paste0("QC_",Tube_number),Tube_number)) 
raw_data_CSF_final = raw_data_CSF[,c(896,897,4:895)]

# -> plasma
raw_data_plasma_1 = read_excel("data input/Premodials_Plasma_Areas.xlsx", 
    sheet = "2025-07-09 Predmodials_Batch1")
raw_data_plasma_2 = read_excel("data input/Premodials_Plasma_Areas.xlsx", 
    sheet = "2025-07-10 Predmodials_Batch2")
raw_data_plasma_3 = read_excel("data input/Premodials_Plasma_Areas.xlsx", 
    sheet = "2025-07-11 Predmodials_Batch3")
raw_data_plasma_4 = read_excel("data input/Premodials_Plasma_Areas.xlsx", 
    sheet = "2025-07-29 Predmodials_Batch4")
raw_data_plasma_5 = read_excel("data input/Premodials_Plasma_Areas.xlsx", 
    sheet = "2025-07-30 Predmodials_Batch5")
raw_data_plasma_6 = read_excel("data input/Premodials_Plasma_Areas.xlsx", 
    sheet = "2025-07-31 Predmodials_Batch6")
raw_data_plasma_7 = read_excel("data input/Premodials_Plasma_Areas.xlsx", 
    sheet = "2025-08-01 Predmodials_Batch7")
raw_data_plasma <- do.call("rbind",list(raw_data_plasma_1,
                                     raw_data_plasma_2,
                                     raw_data_plasma_3,
                                     raw_data_plasma_4,
                                     raw_data_plasma_5,
                                     raw_data_plasma_6,
                                     raw_data_plasma_7)) %>%
  mutate(Tube_number = str_extract(`Sample Name`, "(?<=_)\\d+(?=_)"),
         Batch = paste0("Batch ",str_extract(`Sample Name`,"(?<=_)(\\d+)$")),
         Tube_number = if_else(str_starts(`Sample Name`,"QC_"),
                               paste0("QC_",Tube_number),Tube_number)) 
raw_data_plasma_final = raw_data_plasma[,c(896,897,4:895)]
```

#### - CSF
```{r data-structure-patient-info-CSF, message=F,warning=FALSE}
## sample info - CSF
paged_table(lipidomics_CSF_all)
dim(lipidomics_CSF_all)
lipidomics_CSF_all_summary <- lipidomics_CSF_all %>%
  group_by(Visit) %>%
  summarise(
    total_patients = n_distinct(Patient, na.rm = TRUE),
    total_tubes = n_distinct(Tube_number, na.rm = TRUE),
    total_patients_tubes_pairs = n_distinct(
      paste(Patient, Tube_number)[!is.na(Patient) & !is.na(Tube_number)]))
lipidomics_CSF_all_summary

# which tube IDs are missing for Patient IDs at V0
lipidomics_CSF_all_V0 = lipidomics_CSF_all %>%
  filter(Visit == "V0")
paged_table(lipidomics_CSF_all_V0 %>%
  filter(is.na(Tube_number) & !is.na(Patient)))

# check which Patient IDs are duplicated at V0
paged_table(lipidomics_CSF_all_V0 %>%
  filter(Patient %in% lipidomics_CSF_all_V0[duplicated(lipidomics_CSF_all_V0$Patient) & !is.na(lipidomics_CSF_all_V0$Patient),]$Patient))

# which tube IDs are missing for Patient IDs at V1
lipidomics_CSF_all_V1 = lipidomics_CSF_all %>%
  filter(Visit == "V1")
paged_table(lipidomics_CSF_all_V1 %>%
  filter(is.na(Tube_number) & !is.na(Patient)))

# check which Patient IDs are duplicated at V1
paged_table(lipidomics_CSF_all_V1 %>%
  filter(Patient %in% lipidomics_CSF_all_V1[duplicated(lipidomics_CSF_all_V1$Patient) & !is.na(lipidomics_CSF_all_V1$Patient),]$Patient))

```

#### - Plasma
```{r data-structure-patient-info-plasma, message=F,warning=FALSE}
## sample info - plasma
paged_table(lipidomics_plasma_all)
dim(lipidomics_plasma_all)
lipidomics_plasma_all_summary <- lipidomics_plasma_all %>%
  group_by(Visit) %>%
   summarise(
    total_patients = n_distinct(Patient, na.rm = TRUE),
    total_tubes = n_distinct(Tube_number, na.rm = TRUE),
    total_patients_tubes_pairs = n_distinct(
      paste(Patient, Tube_number)[!is.na(Patient) & !is.na(Tube_number)]))
lipidomics_plasma_all_summary

# which tube IDs are missing for Patient IDs at V0
lipidomics_plasma_all_V0 = lipidomics_plasma_all %>%
  filter(Visit == "V0")
paged_table(lipidomics_plasma_all_V0 %>%
  filter(is.na(Tube_number) & !is.na(Patient)))

# check which Patient IDs are duplicated at V0
paged_table(lipidomics_plasma_all_V0 %>%
  filter(Patient %in% lipidomics_plasma_all_V0[duplicated(lipidomics_plasma_all_V0$Patient) & !is.na(lipidomics_plasma_all_V0$Patient),]$Patient))

# which tube IDs are missing for Patient IDs at V1
lipidomics_plasma_all_V1 = lipidomics_plasma_all %>%
  filter(Visit == "V1")
paged_table(lipidomics_plasma_all_V1 %>%
  filter(is.na(Tube_number) & !is.na(Patient)))

# check which Patient IDs are duplicated at V1
paged_table(lipidomics_plasma_all_V1 %>%
  filter(Patient %in% lipidomics_plasma_all_V1[duplicated(lipidomics_plasma_all_V1$Patient) & !is.na(lipidomics_plasma_all_V1$Patient),]$Patient))
```

#### - Urine
```{r data-structure-patient-info-urine, message=F}
## sample info - urine
paged_table(lipidomics_urine_all)
dim(lipidomics_urine_all)
lipidomics_urine_all_summary <- lipidomics_urine_all %>%
  group_by(Visit) %>%
  summarise(
    total_patients = n_distinct(Patient, na.rm = TRUE),
    total_tubes = n_distinct(Tube_number, na.rm = TRUE),
    total_patients_tubes_pairs = n_distinct(
      paste(Patient, Tube_number)[!is.na(Patient) & !is.na(Tube_number)]))
lipidomics_urine_all_summary

# which tube IDs are missing for Patient IDs at V0
lipidomics_urine_all_V0 = lipidomics_urine_all %>%
  filter(Visit == "V0")
paged_table(lipidomics_urine_all_V0 %>%
  filter(is.na(Tube_number) & !is.na(Patient)))

# check which Patient IDs are duplicated at V0
paged_table(lipidomics_urine_all_V0 %>%
  filter(Patient %in% lipidomics_urine_all_V0[duplicated(lipidomics_urine_all_V0$Patient) & !is.na(lipidomics_urine_all_V0$Patient),]$Patient))

# which tube IDs are missing for Patient IDs at V1
lipidomics_urine_all_V1 = lipidomics_urine_all %>%
  filter(Visit == "V1")
paged_table(lipidomics_urine_all_V1 %>%
  filter(is.na(Tube_number) & !is.na(Patient)))

# check which Patient IDs are duplicated at V1
paged_table(lipidomics_urine_all_V1 %>%
  filter(Patient %in% lipidomics_urine_all_V1[duplicated(lipidomics_urine_all_V1$Patient) & !is.na(lipidomics_urine_all_V1$Patient),]$Patient))
```

### Step 2: aggregate all raw files 

The **second step** is to *aggregate* all the raw data files together and save the batch information, in order to check later if there are any batch effects in the data. 

#### - CSF
```{r load-raw-data-and-wrangling-CSF, message=F}
paged_table(raw_data_CSF_final)
dim(raw_data_CSF_final)
# how many rows of QC
length(grep("QC",raw_data_CSF_final$Tube_number))
```

#### - Plasma
```{r load-raw-data-and-wrangling-Plasma, message=F}
paged_table(raw_data_plasma_final)
dim(raw_data_plasma_final)
# how many rows of QC
length(grep("QC",raw_data_plasma_final$Tube_number))
```

## Overview of data

### Step 3: Combine raw data files with patient info

The **third step** is to *combine* the raw data files with the patient information, and check the amount of samples per visit for each fluid.

#### - CSF
```{r raw-data-patient-CSF, message=F,warning=FALSE}
raw_data_CSF_IDs = raw_data_CSF_final %>%
  select(Tube_number,Batch)
raw_data_CSF_IDs <- raw_data_CSF_IDs %>%
  mutate(Tube_number4 = str_sub(Tube_number,-4)) %>% # last 4 digits
  filter(!str_detect(Tube_number, "QC")) # remove 30 QC IDs

# how many IDs in the raw data CSF
length(raw_data_CSF_IDs$Tube_number)
# how many unique IDs in the raw data CSF
length(unique(raw_data_CSF_IDs$Tube_number))

lipidomics_CSF_all <- lipidomics_CSF_all %>%
  mutate(Tube_number4 = str_sub(Tube_number,-4)) # last 4 digits
full_match_CSF = raw_data_CSF_IDs %>%
  left_join(lipidomics_CSF_all,by = "Tube_number") %>%
  mutate(match_type = ifelse(!is.na(Tube_number4.y),"Full",NA))
no_match_CSF = full_match_CSF %>%
  filter(is.na(match_type)) %>%
  dplyr::rename(Tube_number4 = Tube_number4.y) %>%
  select(-names(lipidomics_CSF_all)) %>%
  dplyr::rename(Tube_number4 = Tube_number4.x)
last4_match_CSF = no_match_CSF %>%
  left_join(lipidomics_CSF_all %>% 
              filter(!Tube_number %in% (full_match_CSF %>% filter(!is.na(match_type)) %>%
                                          pull(Tube_number))),
            by = "Tube_number4") %>%
  mutate(match_type = ifelse(!is.na(Tube_number),"Last4","No match"))

# final description of the samples available in the raw data without QC samples
combined_data_CSF = full_match_CSF %>%
  filter(!is.na(match_type)) %>%
  select(-c(Tube_number4.x,Tube_number4.y,match_type)) %>%
  bind_rows(last4_match_CSF %>% 
              select(-Tube_number) %>% 
              left_join(raw_data_CSF_IDs %>% select(Tube_number,Tube_number4) %>%
                          filter(!Tube_number %in% (full_match_CSF %>% filter(!is.na(match_type)) %>%
                                          pull(Tube_number)))) %>%
              select(Tube_number,Patient,Position,Biofluid,Visit,Country,Rack,Box,Batch)) %>%
  distinct()

paged_table(combined_data_CSF)
# how many IDs in the raw data CSF now 
length(combined_data_CSF$Tube_number)
# how many unique IDs in the raw data CSF now
length(unique(combined_data_CSF$Tube_number))
# how many unique Patient IDs
length(unique(na.omit(combined_data_CSF$Patient)))

# how many tube numbers and patient IDs per V0 and V1
combined_data_CSF %>%
  group_by(Visit) %>%
  summarise(
    total_patients = n_distinct(Patient, na.rm = TRUE), # amount of patient IDs
    total_tubes = n_distinct(Tube_number, na.rm = TRUE), # amount of tube numbers
    total_patients_tubes_pairs = n_distinct(
      paste(Patient, Tube_number)[!is.na(Patient) & !is.na(Tube_number)])) # amount of pairs

# which Tube numbers at V1 do not have a patient ID
combined_data_CSF %>%
  filter(Visit == "V1") %>%
  filter(is.na(Patient))

# patients at V0 and V1
patients_CSF_V0 <- combined_data_CSF %>%
  filter(Visit == "V0") %>%
  pull(Patient) %>%
  unique()
patients_CSF_V1 <- combined_data_CSF %>%
  filter(Visit == "V1") %>%
  pull(Patient) %>%
  unique() %>% 
  na.omit()

# check if all patients at V1 are at V0
all(patients_CSF_V1 %in% patients_CSF_V0)

patients_CSF_V1[!patients_CSF_V1 %in% patients_CSF_V0] # patient TR319

# check patient in the info_patient dataset
lipidomics_CSF_all[lipidomics_CSF_all$Patient %in% patients_CSF_V1[!patients_CSF_V1 %in% patients_CSF_V0],]
```


#### - Plasma
```{r raw-data-patient-Plasma, message=F,warning=FALSE}
raw_data_plasma_IDs = raw_data_plasma_final %>%
  select(Tube_number,Batch)
raw_data_plasma_IDs <- raw_data_plasma_IDs %>%
  mutate(Tube_number4 = str_sub(Tube_number,-4)) %>% # last 4 digits
  filter(!str_detect(Tube_number, "QC")) # remove 66 QC IDs

# how many IDs in the raw data plasma
length(raw_data_plasma_IDs$Tube_number)
# how many unique IDs in the raw data plasma
length(unique(raw_data_plasma_IDs$Tube_number))

lipidomics_plasma_all <- lipidomics_plasma_all %>%
  mutate(Tube_number4 = str_sub(Tube_number,-4)) # last 4 digits
full_match_plasma = raw_data_plasma_IDs %>%
  left_join(lipidomics_plasma_all,by = "Tube_number") %>%
  mutate(match_type = ifelse(!is.na(Tube_number4.y),"Full",NA))
no_match_plasma = full_match_plasma %>%
  filter(is.na(match_type)) %>%
  dplyr::rename(Tube_number4 = Tube_number4.y) %>%
  select(-names(lipidomics_plasma_all)) %>%
  dplyr::rename(Tube_number4 = Tube_number4.x)
last4_match_plasma = no_match_plasma %>%
  left_join(lipidomics_plasma_all,by = "Tube_number4") %>%
  mutate(match_type = ifelse(!is.na(Tube_number),"Last4","No match"))

# final description of the samples available in the raw data without QC samples
combined_data_plasma = full_match_plasma %>%
  filter(!is.na(match_type)) %>%
  select(-c(Tube_number4.x,Tube_number4.y,match_type)) %>%
  bind_rows(last4_match_plasma %>% 
              select(-Tube_number) %>% 
              left_join(raw_data_plasma_IDs %>% select(Tube_number,Tube_number4)) %>%
              select(Tube_number,Patient,Position,Biofluid,Visit,Country,Rack,Box,Batch)) %>%
  distinct()

paged_table(combined_data_plasma)
# how many IDs in the raw data plasma now 
length(combined_data_plasma$Tube_number)
# how many unique IDs in the raw data plasma now
length(unique(combined_data_plasma$Tube_number))
# how many unique Patient IDs
length(unique(na.omit(combined_data_plasma$Patient)))

# how many tube numbers and patient IDs per V0 and V1
combined_data_plasma %>%
  group_by(Visit) %>%
  summarise(
    total_patients = n_distinct(Patient, na.rm = TRUE), # amount of patient IDs
    total_tubes = n_distinct(Tube_number, na.rm = TRUE), # amount of tube numbers
    total_patients_tubes_pairs = n_distinct(
      paste(Patient, Tube_number)[!is.na(Patient) & !is.na(Tube_number)])) # amount of pairs

# which Tube numbers at V0 do not have a patient ID
combined_data_plasma %>%
  filter(Visit == "V0") %>%
  filter(is.na(Patient))

# which Tube numbers at V1 do not have a patient ID
combined_data_plasma %>%
  filter(Visit == "V1") %>%
  filter(is.na(Patient))

# patients at V0 and V1
patients_plasma_V0 <- combined_data_plasma %>%
  filter(Visit == "V0") %>%
  pull(Patient) %>%
  unique()
patients_plasma_V1 <- combined_data_plasma %>%
  filter(Visit == "V1") %>%
  pull(Patient) %>%
  unique() %>% 
  na.omit()

# check if all patients at V1 are at V0
all(patients_plasma_V1 %in% patients_plasma_V0)

patients_plasma_V1[!patients_plasma_V1 %in% patients_plasma_V0] # patients TR207, TR116 and TR123

# check patient in the info_patient dataset
lipidomics_plasma_all[lipidomics_plasma_all$Patient %in% patients_plasma_V1[!patients_plasma_V1 %in% patients_plasma_V0],]
```

#### Step 4: Overview of the samples based on status 

The **fourth step** is to *give an overview* of how many samples of *eALS*, *PGMC*, *CTR* and *mimic* we have *per fluid*, *visit* and *country*.

```{r overview-IDs, message=F,warning=FALSE,echo=FALSE}
# General documentation info
GeneralDocumentation <- read_delim("data input/export-2025-11-07-PREMODIALS-AKDTR_BRNO_CHUFR_HMCIL_HRO_KSSGCH_MRI_NIUSASSK/GeneralDocumentation.csv", 
           delim = ";", escape_double = FALSE, trim_ws = TRUE)

# IDS of patients
# -> ALS patients
ALS_ID <- GeneralDocumentation %>%
  filter((ALSuncertainty == 1 | ALSFUdiagnosis == 1) & ALSFUdiagnosis %in% c(1,3,NA)) %>%
  select(PatientID,ParticipantCode) %>% 
  mutate(type = "ALS")

# -> CTR 
CTR_ID <- GeneralDocumentation %>%
  filter(PGMC == 2) %>%
  select(PatientID,ParticipantCode) %>% 
  mutate(type = "CTR")

# -> PGMC
PGMC_ID <- GeneralDocumentation %>%
  filter(PGMC == 1) %>%
  select(PatientID,ParticipantCode) %>% 
  mutate(type = "PGMC")

# -> Mimic
mimic_ID <- GeneralDocumentation %>%
  filter((ALSuncertainty == 2 | ALSFUdiagnosis == 2) & ALSFUdiagnosis %in% c(2,NA)) %>%
  select(PatientID,ParticipantCode) %>% 
  mutate(type = "mimic")

# -> SYMP
SYMP_ID <- GeneralDocumentation %>%
  filter(PGMC == 3 & ALSuncertainty == 3 & ALSFUdiagnosis %in% c(3,NA)) %>%
  select(PatientID,ParticipantCode) %>% 
  mutate(type = "SYMP")

NA_ID <- data.frame(PatientID = NA, ParticipantCode = "DENa1",type = "N.A.")

# PGMC IDs with mutations
PGMC_mutations_ID <- GeneralDocumentation %>%
  select(PatientID, ParticipantCode,PGMC,contains("MutationType")) %>%
  filter(PatientID %in% PGMC_ID$PatientID)
PGMC_mutations_ID_tmp <- sapply(apply(PGMC_mutations_ID[,4:17],1,
                                  function(x){which(x == 1)}) %>% unique(), function(x) x + 3)
PGMC_mutations_ID <- PGMC_mutations_ID[,c(1,2,unlist(PGMC_mutations_ID_tmp))]
PGMC_mutations_ID <- PGMC_mutations_ID %>%
  mutate(type = ifelse(MutationTypeC9orf72 == 1,"C9orf72",
                       ifelse(MutationTypeSOD1 == 1,"SOD1",
                              ifelse(MutationTypeFUS == 1, "FUS",
                              ifelse(MutationTypeTARDBP == 1,"TARDBP",
                                            ifelse(MutationTypeOther==1 | MutationTypeUBQLN2==1 | MutationTypeFIG4==1 ,"other",NA)))))) %>%
  select(PatientID,ParticipantCode,type) %>%
  filter(!is.na(type))

# ALS IDs with mutations
ALS_mutations_ID <- GeneralDocumentation %>%
  select(PatientID, ParticipantCode,PGMC,contains("MutationType")) %>%
  filter(PatientID %in% ALS_ID$PatientID)
ALS_mutations_ID_tmp <- sapply(apply(ALS_mutations_ID[,4:17],1,
                                  function(x){which(x == 1)}) %>% unique(), function(x) x + 3)
ALS_mutations_ID <- ALS_mutations_ID[,c(1,2,4,5,6,8,17)]
ALS_mutations_ID <- ALS_mutations_ID %>%
  mutate(type = ifelse(MutationTypeC9orf72 == 1,"C9orf72",
                       ifelse(MutationTypeSOD1 == 1,"SOD1",
                              ifelse(MutationTypeTARDBP == 1,"TARDBP",
                                            ifelse(MutationTypeOther==1 | MutationTypeFIG4==1 ,"other",NA))))) %>%
  select(PatientID,ParticipantCode,type) %>%
  filter(!is.na(type))

all_participants_IDs = do.call("rbind",
                               list(CTR_ID,
                                    ALS_ID,
                                    PGMC_ID,
                                    mimic_ID,
                                    SYMP_ID,
                                    NA_ID,
                                    PGMC_mutations_ID))
writexl::write_xlsx(all_participants_IDs,"results/all_participants_IDs.xlsx")

# Get info of sex and age for all participants
participants_PGMC = read_excel("data input/recruited participants.xlsx", 
                               sheet = "Total PGMC") %>%
  select(Pseudonyme,sex,age) 
participants_CTR = read_excel("data input/recruited participants.xlsx", 
                              sheet = "Total Control") %>%
  dplyr::select(Pseudonyme,Sex,`Age...7`) %>%
  dplyr::rename(sex = Sex,
         age = `Age...7`)
participants_ALS_mimic = read_excel("data input/recruited participants.xlsx", 
                                    sheet = "Total EALS-Mimics") %>%
  dplyr::select(Pseudonyme,Sex,`Age...7`) %>%
  dplyr::rename(sex = Sex,
         age = `Age...7`)
Sex_age_all_participants = do.call("rbind",list(participants_PGMC,
                                                participants_CTR,
                                                participants_ALS_mimic))
```

#### - CSF (the patient IDs given by Laura) - not displaying, but it is in code
```{r overview-IDs-CSF-Laura, message=F,warning=FALSE, echo = FALSE}
# IDs in CSF (131)
IDs_CSF <- read_delim("data input/export-2025-11-07-PREMODIALS-AKDTR_BRNO_CHUFR_HMCIL_HRO_KSSGCH_MRI_NIUSASSK/CSFAcquisition.csv",
                          delim = ";", escape_double = FALSE, trim_ws = TRUE) %>%
  filter(CsfSexists == 1) %>%
  group_by(PatientID) %>%
  mutate(Visit = paste0("V", row_number() - 1)) %>%
  ungroup() %>% 
  select(PatientID,Visit) %>% 
  distinct()
IDs_CSF_data_1 = IDs_CSF %>%
  left_join(GeneralDocumentation %>% select(PatientID,ParticipantCode)) %>%
  dplyr::rename(Patient = ParticipantCode) %>%
  distinct() %>%
  left_join(all_participants_IDs %>% dplyr::rename(Patient = ParticipantCode)) %>%
  mutate(
    Country = dplyr::case_when(
      grepl("TR", Patient) ~ "Turkey",
      grepl("CH", Patient) ~ "Switzerland",
      grepl("DE", Patient) ~ "Germany",
      grepl("SK", Patient) ~ "Slovakia",
      grepl("FR", Patient) ~ "France",
      grepl("IL", Patient) ~ "Israel",
      TRUE                 ~ NA_character_
    )) %>%
  arrange(Patient)

paged_table(IDs_CSF_data_1)

overview_country_CSF_1 = IDs_CSF_data_1 %>%
  group_by(Visit,Country) %>%
  summarise(n_unique_patients = n_distinct(Patient),.groups = "drop") %>%
  arrange(Visit,desc(n_unique_patients))
overview_country_CSF_1

overview_status_CSF_1 = IDs_CSF_data_1 %>%
  group_by(type,Visit,Country) %>% 
  distinct() %>%
  summarise(nr_samples = n_distinct(Patient)) %>%
  select(type, Visit,Country,nr_samples) %>%
  pivot_wider(
    names_from  = type,        
    values_from = nr_samples,  
    values_fill = 0) %>%
  select(Visit,Country,PGMC,CTR,ALS,mimic,SYMP,C9orf72,SOD1,TARDBP,FUS,other,`NA`)
overview_status_CSF_1

```

#### - CSF (the patient IDs existing in the raw data)
```{r overview-IDs-CSF-raw-data, message=F,warning=FALSE}
IDs_CSF_data = combined_data_CSF %>%
  select(Patient,Visit,Tube_number) %>%
  distinct() %>%
  left_join(all_participants_IDs %>% dplyr::rename(Patient = ParticipantCode)) %>%
  mutate(
    Country = dplyr::case_when(
      grepl("TR", Patient) ~ "Turkey",
      grepl("CH", Patient) ~ "Switzerland",
      grepl("DE", Patient) ~ "Germany",
      grepl("SK", Patient) ~ "Slovakia",
      grepl("FR", Patient) ~ "France",
      grepl("IL", Patient) ~ "Israel",
      TRUE                 ~ NA_character_
    )) %>%
  arrange(Patient)

paged_table(IDs_CSF_data)

overview_country_CSF = IDs_CSF_data %>%
  group_by(Visit,Country) %>%
  summarise(n_unique_patients = n_distinct(Patient),.groups = "drop") %>%
  arrange(Visit,desc(n_unique_patients))
overview_country_CSF

overview_status_CSF = IDs_CSF_data %>%
  group_by(type,Visit,Country) %>% 
  distinct() %>%
  summarise(nr_samples = n_distinct(Patient)) %>%
  select(type, Visit,Country,nr_samples) %>%
  pivot_wider(
    names_from  = type,        
    values_from = nr_samples,  
    values_fill = 0) %>%
  select(Visit,Country,PGMC,CTR,ALS,mimic,SYMP,C9orf72,SOD1,TARDBP,FUS,other,N.A.) %>%
  arrange(Visit,Country)
overview_status_CSF

# Date info
date_CTR <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_data[IDs_CSF_data$type == "CTR",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "CTR")
date_ALS <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_data[IDs_CSF_data$type == "ALS",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "ALS")
date_mimic <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_data[IDs_CSF_data$type == "mimic",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "mimic")
date_PGMC <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_data[IDs_CSF_data$type == "PGMC",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "PGMC")
date_SYMP <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_data[IDs_CSF_data$type == "SYMP",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "SYMP")
date_NA = data.frame(Pseudonyme = "6H1HR8R7",age = 58,patient_group = "N.A.")

skim(date_CTR)
skim(date_ALS)
skim(date_mimic)
skim(date_PGMC)
skimr::skim(date_NA)
skimr::skim(date_SYMP)

date_all <- do.call("rbind",list(date_CTR,date_ALS,date_mimic,date_PGMC,date_SYMP,date_NA))

# -> Kruskal Wallis test between samples
kruskal_test(data = date_all,age~patient_group)
dunn_test(data = date_all,age~patient_group)

## Sex analysis
Sex_CTR <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_data[IDs_CSF_data$type == "CTR",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "CTR")
Sex_ALS <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_data[IDs_CSF_data$type == "ALS",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "ALS")
Sex_mimic <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_data[IDs_CSF_data$type == "mimic",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "mimic")
Sex_PGMC <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_data[IDs_CSF_data$type == "PGMC",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "PGMC")
Sex_SYMP <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_data[IDs_CSF_data$type == "SYMP",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "SYMP")
Sex_NA = data.frame(Pseudonyme = "6H1HR8R7",sex = "F",patient_group = "N.A.")

Sex_all <- do.call("rbind",list(Sex_ALS,
                                Sex_CTR,
                                Sex_mimic,
                                Sex_PGMC,
                                Sex_SYMP,
                                Sex_NA))
Sex_all <- Sex_all %>% filter(!is.na(sex))
table(Sex_all$patient_group,Sex_all$sex)
fisher.test(Sex_all$patient_group,Sex_all$sex)
pairwise_fisher_test(table(Sex_all$patient_group,Sex_all$sex), p.adjust.method = "holm")
```

#### - Plasma (the patient IDs given by Laura) - not displaying, but it is in code
```{r overview-IDs-Plasma-Laura, message=F,warning=FALSE, echo=FALSE}
# IDs in plasma (235)
IDs_plasma <- read_delim("data input/export-2025-11-07-PREMODIALS-AKDTR_BRNO_CHUFR_HMCIL_HRO_KSSGCH_MRI_NIUSASSK/BloodAcquisition.csv",
                          delim = ";", escape_double = FALSE, trim_ws = TRUE) %>%
  filter(BAexists == 1) %>% 
  group_by(PatientID) %>%
  mutate(Visit = paste0("V", row_number() - 1)) %>%
  ungroup() %>% 
  select(PatientID,Visit) %>% 
  distinct()

IDs_plasma_data_1 = IDs_plasma %>%
  left_join(GeneralDocumentation %>% select(PatientID,ParticipantCode)) %>%
  dplyr::rename(Patient = ParticipantCode) %>%
  distinct() %>%
  left_join(all_participants_IDs %>% dplyr::rename(Patient = ParticipantCode)) %>%
  mutate(
    Country = dplyr::case_when(
      grepl("TR", Patient) ~ "Turkey",
      grepl("CH", Patient) ~ "Switzerland",
      grepl("DE", Patient) ~ "Germany",
      grepl("SK", Patient) ~ "Slovakia",
      grepl("FR", Patient) ~ "France",
      grepl("IL", Patient) ~ "Israel",
      TRUE                 ~ NA_character_
    )) %>%
  arrange(Patient)

paged_table(IDs_plasma_data_1)

overview_country_plasma_1 = IDs_plasma_data_1 %>%
  group_by(Visit,Country) %>%
  summarise(n_unique_patients = n_distinct(Patient),.groups = "drop") %>%
  arrange(Visit,desc(n_unique_patients))
overview_country_plasma_1

overview_status_plasma_1 = IDs_plasma_data_1 %>%
  group_by(type,Visit,Country) %>% 
  distinct() %>%
  summarise(nr_samples = n_distinct(Patient)) %>%
  select(type, Visit,Country,nr_samples) %>%
  pivot_wider(
    names_from  = type,        
    values_from = nr_samples,  
    values_fill = 0) %>%
  select(Visit,Country,PGMC,CTR,ALS,mimic,SYMP,C9orf72,SOD1,TARDBP,FUS,other,`NA`)
overview_status_plasma_1

```

#### - Plasma (the patient IDs existing in the raw data)
```{r overview-IDs-Plasma-raw-data, message=F,warning=FALSE}
IDs_plasma_data = combined_data_plasma %>%
  select(Patient,Visit,Tube_number) %>%
  distinct() %>%
  left_join(all_participants_IDs %>% dplyr::rename(Patient = ParticipantCode)) %>%
  mutate(
    Country = dplyr::case_when(
      grepl("TR", Patient) ~ "Turkey",
      grepl("CH", Patient) ~ "Switzerland",
      grepl("DE", Patient) ~ "Germany",
      grepl("SK", Patient) ~ "Slovakia",
      grepl("FR", Patient) ~ "France",
      grepl("IL", Patient) ~ "Israel",
      TRUE                 ~ NA_character_
    )) %>%
  arrange(Patient)

paged_table(IDs_plasma_data)

overview_country_plasma = IDs_plasma_data %>%
  group_by(Visit,Country) %>%
  summarise(n_unique_patients = n_distinct(Patient),.groups = "drop") %>%
  arrange(Visit,desc(n_unique_patients))
overview_country_plasma

overview_status_plasma = IDs_plasma_data %>%
  group_by(type,Visit,Country) %>% 
  distinct() %>%
  summarise(nr_samples = n_distinct(Patient)) %>%
  select(type, Visit,Country,nr_samples) %>%
  pivot_wider(
    names_from  = type,        
    values_from = nr_samples,  
    values_fill = 0) %>%
  select(Visit,Country,PGMC,CTR,ALS,mimic,SYMP,C9orf72,SOD1,TARDBP,FUS,other,N.A.) %>%
  arrange(Visit,Country)
overview_status_plasma

# Date info
date_CTR <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_plasma_data[IDs_plasma_data$type == "CTR",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "CTR")
date_ALS <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_plasma_data[IDs_plasma_data$type == "ALS",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "ALS")
date_mimic <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_plasma_data[IDs_plasma_data$type == "mimic",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "mimic")
date_PGMC <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_plasma_data[IDs_plasma_data$type == "PGMC",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "PGMC")
date_SYMP <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_plasma_data[IDs_plasma_data$type == "SYMP",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "SYMP")
date_NA = data.frame(Pseudonyme = "6H1HR8R7",age = 58,patient_group = "N.A.")

skim(date_CTR)
skim(date_ALS)
skim(date_mimic)
skim(date_PGMC)
skimr::skim(date_NA)
skimr::skim(date_SYMP)

date_all <- do.call("rbind",list(date_CTR,date_ALS,date_mimic,date_PGMC,date_SYMP,date_NA))

# -> Kruskal Wallis test between samples
kruskal_test(data = date_all,age~patient_group)
dunn_test(data = date_all,age~patient_group)

## Sex analysis
Sex_CTR <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_plasma_data[IDs_plasma_data$type == "CTR",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "CTR")
Sex_ALS <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_plasma_data[IDs_plasma_data$type == "ALS",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "ALS")
Sex_mimic <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_plasma_data[IDs_plasma_data$type == "mimic",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "mimic")
Sex_PGMC <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_plasma_data[IDs_plasma_data$type == "PGMC",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "PGMC")
Sex_SYMP <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_plasma_data[IDs_plasma_data$type == "SYMP",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "SYMP")
Sex_NA = data.frame(Pseudonyme = "6H1HR8R7",sex = "F",patient_group = "N.A.")

Sex_all <- do.call("rbind",list(Sex_ALS,
                                Sex_CTR,
                                Sex_mimic,
                                Sex_PGMC,
                                Sex_SYMP,
                                Sex_NA))
Sex_all <- Sex_all %>% filter(!is.na(sex))
table(Sex_all$patient_group,Sex_all$sex)
fisher.test(Sex_all$patient_group,Sex_all$sex)
pairwise_fisher_test(table(Sex_all$patient_group,Sex_all$sex), p.adjust.method = "holm")

```

#### - CSF & Plasma (patient IDs in both raw CSF and Plasma data)
```{r overview-IDs-CSF-Plasma-raw-data, message=F,warning=FALSE}
IDs_CSF_plasma_data = rbind(IDs_CSF_data,
                            IDs_plasma_data) %>%
  select(-Tube_number) %>%
  distinct()

overview_country_CSF_plasma = IDs_CSF_plasma_data %>%
  group_by(Visit,Country) %>%
  summarise(n_unique_patients = n_distinct(Patient),.groups = "drop") %>%
  arrange(Visit,desc(n_unique_patients))
overview_country_CSF_plasma

overview_status_CSF_plasma = IDs_CSF_plasma_data %>%
  group_by(type,Visit,Country) %>% 
  distinct() %>%
  summarise(nr_samples = n_distinct(Patient)) %>%
  select(type, Visit,Country,nr_samples) %>%
  pivot_wider(
    names_from  = type,        
    values_from = nr_samples,  
    values_fill = 0) %>%
  select(Visit,Country,PGMC,CTR,ALS,mimic,SYMP,C9orf72,SOD1,TARDBP,FUS,other,N.A.) %>%
  arrange(Visit,Country)
overview_status_CSF_plasma

# overview of ALS mutations
ALS_mutations_ID %>%
    select(PatientID,type) %>%
    filter(PatientID %in% na.omit((IDs_CSF_plasma_data[IDs_CSF_plasma_data$type == "ALS",]$PatientID %>%unique()))) %>%
  arrange(type)

# Date info
date_CTR <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_plasma_data[IDs_CSF_plasma_data$type == "CTR",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "CTR")
date_ALS <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_plasma_data[IDs_CSF_plasma_data$type == "ALS",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "ALS")
date_mimic <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_plasma_data[IDs_CSF_plasma_data$type == "mimic",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "mimic")
date_PGMC <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_plasma_data[IDs_CSF_plasma_data$type == "PGMC",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "PGMC")
date_SYMP <- Sex_age_all_participants %>%
  select(Pseudonyme,age) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_plasma_data[IDs_CSF_plasma_data$type == "SYMP",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "SYMP")
date_NA = data.frame(Pseudonyme = "6H1HR8R7",age = 58,patient_group = "N.A.")

skim(date_CTR)
skim(date_ALS)
skim(date_mimic)
skim(date_PGMC)
skimr::skim(date_NA)
skimr::skim(date_SYMP)

#date_all <- do.call("rbind",list(date_CTR,date_ALS,date_mimic,date_PGMC,date_SYMP,date_NA))
date_all <- do.call("rbind",list(date_CTR,date_ALS,date_mimic,date_PGMC))

# -> Kruskal Wallis test between samples
kruskal_test(data = date_all,age~patient_group)
dunn_test(data = date_all,age~patient_group)

## Sex analysis
Sex_CTR <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_plasma_data[IDs_CSF_plasma_data$type == "CTR",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "CTR")
Sex_ALS <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_plasma_data[IDs_CSF_plasma_data$type == "ALS",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "ALS")
Sex_mimic <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_plasma_data[IDs_CSF_plasma_data$type == "mimic",]$PatientID %>%unique()))) %>%
  mutate(patient_group = "mimic")
Sex_PGMC <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_plasma_data[IDs_CSF_plasma_data$type == "PGMC",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "PGMC")
Sex_SYMP <- Sex_age_all_participants %>%
  select(Pseudonyme,sex) %>%
  filter(Pseudonyme %in% na.omit((IDs_CSF_plasma_data[IDs_CSF_plasma_data$type == "SYMP",]$PatientID %>%unique())))  %>%
  mutate(patient_group = "SYMP")
Sex_NA = data.frame(Pseudonyme = "6H1HR8R7",sex = "F",patient_group = "N.A.")

Sex_all <- do.call("rbind",list(Sex_ALS,
                                Sex_CTR,
                                Sex_mimic,
                                Sex_PGMC))
                                # Sex_SYMP,
                                # Sex_NA))
Sex_all <- Sex_all %>% filter(!is.na(sex))
table(Sex_all$patient_group,Sex_all$sex)
fisher.test(Sex_all$patient_group,Sex_all$sex)
pairwise_fisher_test(table(Sex_all$patient_group,Sex_all$sex), p.adjust.method = "holm")
```

## Bioinformatic analyses

#### Step 5: creation of summarised experiment datasets

The **fifth step** is to *remove* the QC rows, *save* the experimental setup (info of patient ID, batch, sample ID, visit, etc.), *structure* the lipidomics dataset to numeric and *create* summarised experiments datasets.

#### - CSF
```{r summarised-experiments-CSF, message=F,warning=FALSE}
# removal of QC rows
raw_data_CSF_use = raw_data_CSF_final %>%
  filter(!str_detect(Tube_number, "QC"))

tube_batch_CSF = raw_data_CSF_use[,1:2] %>%
  left_join(combined_data_CSF %>% select(Tube_number,Batch,Patient,Visit))
raw_data_CSF_use_mat = as.matrix(raw_data_CSF_use[,3:ncol(raw_data_CSF_use)])
rownames(raw_data_CSF_use_mat) = tube_batch_CSF %>% pull(Tube_number)

# matrix with raw lipidomics data (rows - lipids and column - tube ID)
lipidomics_CSF = as.data.frame(t(raw_data_CSF_use_mat))
dim(lipidomics_CSF)

# make columns numeric
for(i in 1:ncol(lipidomics_CSF)){lipidomics_CSF[,i] = as.numeric(lipidomics_CSF[,i])}

#make a list for all dataframes
lipidomics_data_CSF = list(raw_data = lipidomics_CSF)

## summarized objects 
tube_batch_CSF = tube_batch_CSF %>% 
  left_join(IDs_CSF_data) %>%
  mutate(subtype = ifelse(type == "C9orf72","C9orf72",
                          ifelse(type == "SOD1","SOD1",
                                 ifelse(type == "FUS","FUS",
                                        ifelse(type == "other","other",
                                               ifelse(type == "TARDBP","TARDBP",NA)))))) %>%
  mutate(type = ifelse(type %in% c("C9orf72","SOD1","FUS","TARDBP","other"),
                       "PGMC",type)) %>%
  arrange(subtype) %>%
  distinct(Tube_number, Batch,Patient,PatientID,type, .keep_all = TRUE)

# Check which tube numbers do not have a patient ID or type assigned (majority uncertain PURE MOTOR SYMPTOM (PMS) / MND MIMIC / EARLY ALS (EALS))
tube_number_CSF_missing = tube_batch_CSF %>%
  filter(is.na(Patient) | is.na(type)) %>%
  arrange(Patient)
tube_number_CSF_missing

GeneralDocumentation %>%
  select(ParticipantCode,PatientID,PGMC,ALSuncertainty,ALSFUdiagnosis) %>%
  filter(ParticipantCode %in% tube_number_CSF_missing$Patient) %>%
  filter(!is.na(ParticipantCode))

abundance.columns <- 1:ncol(lipidomics_data_CSF$raw_data) # get abundance column numbers
      clin = data.frame(label = tube_batch_CSF$Tube_number, 
                        condition = tube_batch_CSF$type,
                        sub_condition = tube_batch_CSF$subtype,
                        batch = tube_batch_CSF$Batch)
      
      lipidomics_data_CSF$raw_data$name = lipidomics_data_CSF$raw_data$ID = rownames(lipidomics_data_CSF$raw_data)
      experimental.design = clin
      experimental.design <- experimental.design %>%
        group_by(condition) %>%            
        mutate(replicate = row_number()) %>%
        ungroup()
      
      lipidomics_data_CSF$se <- make_se(lipidomics_data_CSF$raw_data, abundance.columns, experimental.design)
lipidomics_data_CSF$se

 writexl::write_xlsx(lipidomics_data_CSF$raw_data,"results/lipidomics_CSF_raw_data.xlsx")
```

#### - Plasma 
```{r summarised-experiments-Plasma, message=F,warning=FALSE}
# removal of QC rows
raw_data_plasma_use = raw_data_plasma_final %>%
  filter(!str_detect(Tube_number, "QC"))

tube_batch_plasma = raw_data_plasma_use[,1:2] %>%
  left_join(combined_data_plasma %>% select(Tube_number,Batch,Patient,Visit))
raw_data_plasma_use_mat = as.matrix(raw_data_plasma_use[,3:ncol(raw_data_plasma_use)])
rownames(raw_data_plasma_use_mat) = tube_batch_plasma %>% pull(Tube_number)

# matrix with raw lipidomics data (rows - lipids and column - tube ID)
lipidomics_plasma = as.data.frame(t(raw_data_plasma_use_mat))
dim(lipidomics_plasma)

# make columns numeric
for(i in 1:ncol(lipidomics_plasma)){lipidomics_plasma[,i] = as.numeric(lipidomics_plasma[,i])}

#make a list for all dataframes
lipidomics_data_plasma = list(raw_data = lipidomics_plasma)

## summarized objects 
tube_batch_plasma = tube_batch_plasma %>% 
  left_join(IDs_plasma_data) %>%
  mutate(subtype = ifelse(type == "C9orf72","C9orf72",
                          ifelse(type == "SOD1","SOD1",
                                 ifelse(type == "FUS","FUS",
                                        ifelse(type == "other","other",
                                               ifelse(type == "TARDBP","TARDBP",NA)))))) %>%
  mutate(type = ifelse(type %in% c("C9orf72","SOD1","FUS","TARDBP","other"),
                       "PGMC",type)) %>%
  arrange(subtype) %>%
  distinct(Tube_number, Batch,Patient,PatientID,type, .keep_all = TRUE)

# Check which tube numbers do not have a patient ID or type assigned (majority uncertain PURE MOTOR SYMPTOM (PMS) / MND MIMIC / EARLY ALS (EALS))
tube_number_plasma_missing = tube_batch_plasma %>%
  filter(is.na(Patient) | is.na(type)) %>%
  arrange(Patient)
tube_number_plasma_missing

GeneralDocumentation %>%
  select(ParticipantCode,PatientID,PGMC,ALSuncertainty,ALSFUdiagnosis) %>%
  filter(ParticipantCode %in% tube_number_plasma_missing$Patient) %>%
  filter(!is.na(ParticipantCode))

abundance.columns <- 1:ncol(lipidomics_data_plasma$raw_data) # get abundance column numbers
      clin = data.frame(label = tube_batch_plasma$Tube_number, 
                        condition = tube_batch_plasma$type,
                        sub_condition = tube_batch_plasma$subtype,
                        batch = tube_batch_plasma$Batch)
      
      lipidomics_data_plasma$raw_data$name = lipidomics_data_plasma$raw_data$ID = rownames(lipidomics_data_plasma$raw_data)
      experimental.design = clin
      experimental.design <- experimental.design %>%
        group_by(condition) %>%            
        mutate(replicate = row_number()) %>%
        ungroup()
      
      lipidomics_data_plasma$se <- make_se(lipidomics_data_plasma$raw_data, abundance.columns, experimental.design)
 lipidomics_data_plasma$se
 
 writexl::write_xlsx(lipidomics_data_plasma$raw_data,"results/lipidomics_plasma_raw_data.xlsx")
```

#### Step 6: missing analyses

The **sixth step** is to *check* for missing omics per patient and overall, *filter* lipids that are not quantified in less than 1/3 of the samples and *normalise* the data (using vsn).

#### - CSF 
```{r missing inspection-CSF}
# heatmap missing 
vis_miss(lipidomics_data_CSF$raw_data,show_perc = TRUE,show_perc_col = TRUE,cluster = F)
ggsave("plots/missing_vis_miss_heatmap_CSF.png", width = 15, height = 10, units = "in")

# filter for lipids that are quantified in at least 2/3 of the samples
lipidomics_data_CSF$se_filtered = filter_proteins(lipidomics_data_CSF$se,"fraction",min = 0.66)

#dimensions of the data
dim(lipidomics_data_CSF$se)
dim(lipidomics_data_CSF$se_filtered)

# heatmap missing for filtered data
vis_miss(as.data.frame(assay(lipidomics_data_CSF$se_filtered)),show_perc = TRUE,show_perc_col = TRUE,cluster = F)
ggsave("plots/missing_vis_miss_heatmap_filtered_CSF.png", width = 12, height = 8, units = "in")

plot_frequency(lipidomics_data_CSF$se)
ggsave("plots/frequency_met_identification_raw_CSF.pdf", width = 11, height = 8, units = "in")
plot_frequency(lipidomics_data_CSF$se_filtered)
ggsave("plots/frequency_met_identification_filtered_CSF.pdf", width = 11, height = 8, units = "in")

# % missing per patient: 
round(apply(X = as.data.frame(assay(lipidomics_data_CSF$se)), function(x) sum(is.na(x)), MARGIN = 2) / nrow(as.data.frame(assay(lipidomics_data_CSF$se))) * 100 , 1)
round(apply(X = as.data.frame(assay(lipidomics_data_CSF$se_filtered)), function(x) sum(is.na(x)), MARGIN = 2) / nrow(as.data.frame(assay(lipidomics_data_CSF$se_filtered))) * 100 , 1)

#normalization
lipidomics_data_CSF$se_filt_norm <- normalize_vsn(lipidomics_data_CSF$se_filtered)
DEP::meanSdPlot(lipidomics_data_CSF$se_filt_norm)

writexl::write_xlsx(as.data.frame(assay(lipidomics_data_CSF$se_filtered)),"results/data_filtered_CSF.xlsx")
writexl::write_xlsx(as.data.frame(assay(lipidomics_data_CSF$se_filt_norm)),"results/data_filtered_normalized_CSF.xlsx")

# imputation
lipidomics_data_CSF$se_filt_impute <- impute(
  lipidomics_data_CSF$se_filt_norm,fun = "MinProb",q = 0.01)

writexl::write_xlsx(as.data.frame(assay(lipidomics_data_CSF$se_filt_impute)),"results/data_filtered_normalized_imputed_CSF.xlsx")
```

#### - Plasma 

```{r missing inspection-plasma}
# heatmap missing 
vis_miss(lipidomics_data_plasma$raw_data,show_perc = TRUE,show_perc_col = TRUE,cluster = F)
ggsave("plots/missing_vis_miss_heatmap_plasma.png", width = 15, height = 10, units = "in")

# filter for lipids that are quantified in at least 2/3 of the samples
lipidomics_data_plasma$se_filtered = filter_proteins(lipidomics_data_plasma$se,"fraction",min = 0.66)

#dimensions of the data
dim(lipidomics_data_plasma$se)
dim(lipidomics_data_plasma$se_filtered)

# heatmap missing for filtered data
vis_miss(as.data.frame(assay(lipidomics_data_plasma$se_filtered)),show_perc = TRUE,show_perc_col = TRUE,cluster = F)
ggsave("plots/missing_vis_miss_heatmap_filtered_plasma.png", width = 12, height = 8, units = "in")

plot_frequency(lipidomics_data_plasma$se)
ggsave("plots/frequency_met_identification_raw_plasma.pdf", width = 11, height = 8, units = "in")
plot_frequency(lipidomics_data_plasma$se_filtered)
ggsave("plots/frequency_met_identification_filtered_plasma.pdf", width = 11, height = 8, units = "in")

# % missing per patient: 
round(apply(X = as.data.frame(assay(lipidomics_data_plasma$se)), function(x) sum(is.na(x)), MARGIN = 2) / nrow(as.data.frame(assay(lipidomics_data_plasma$se))) * 100 , 1)
round(apply(X = as.data.frame(assay(lipidomics_data_plasma$se_filtered)), function(x) sum(is.na(x)), MARGIN = 2) / nrow(as.data.frame(assay(lipidomics_data_plasma$se_filtered))) * 100 , 1)

#normalization
lipidomics_data_plasma$se_filt_norm <- normalize_vsn(lipidomics_data_plasma$se_filtered)
DEP::meanSdPlot(lipidomics_data_plasma$se_filt_norm)

writexl::write_xlsx(as.data.frame(assay(lipidomics_data_plasma$se_filtered)),"results/data_filtered_plasma.xlsx")
writexl::write_xlsx(as.data.frame(assay(lipidomics_data_plasma$se_filt_norm)),"results/data_filtered_normalized_plasma.xlsx")

# imputation
lipidomics_data_plasma$se_filt_impute <- impute(
  lipidomics_data_plasma$se_filt_norm,fun = "MinProb",q = 0.01)

writexl::write_xlsx(as.data.frame(assay(lipidomics_data_plasma$se_filt_impute)),"results/data_filtered_normalized_imputed_plasma.xlsx")

```

#### Step 7: Visualizations

The **seventh step** is to *create visualizations*, such as heatmaps and PCAs (for each fluid with ID/batch info, and for both fluids together)

```{r visualizations-functions,echo=FALSE}
mean_expression_plot = function(data, file_sample, file_mass, title){
  ggplot(data = reshape2::melt(data), aes(x=Var1, y=value)) +
  geom_boxplot(color="darkseagreen4", fill="darkseagreen3") +
  theme_set(theme_minimal()) +
  theme_few() +
  scale_colour_few() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(axis.text=element_text(size=6)) +
  ggtitle(title)

ggsave(file_sample, width = 11, height = 8, units = "in")

ggplot(data = reshape2::melt(data), aes(x=reorder(as.factor(Var2),value), y=value)) +
  geom_boxplot(color="darkseagreen4", fill="darkseagreen3") +
  theme_set(theme_minimal()) +
  theme_few() +
  scale_colour_few() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(axis.text=element_text(size=6))+
  ggtitle(title)

ggsave(file_mass, width = 11*2, height = 8, units = "in")
}

set.seed(9)

#functions for saving the heatmaps as figures
        
save_pheatmap_pdf <- function(x, filename, width=11, height=8) {
   stopifnot(!missing(x))
   stopifnot(!missing(filename))
   pdf(filename, width=width, height=height)
   grid::grid.newpage()
   grid::grid.draw(x$gtable)
   dev.off()
}
        
make_pheatmap <- function(data, cluster_cols = T, main = "Heatmap", clustering_method = "ward.D", show_rownames = T,labels_col = clin$label,color){
  p = pheatmap::pheatmap(data, name = "expression", cutree_cols = 1,
          show_colnames = T,
          show_rownames = show_rownames,
          fontsize = 4,
          fontsize_col = 4,
          fontsize_row = 2, 
          annotation_col = annotation_col,
          annotation_colors = annotation_colours,
          annotation_row = annotation_row,
          color = color,
          main = main,
          border_color=NA,
          cluster_cols = cluster_cols,
          cluster_rows = F,
          labels_col = labels_col,
          #clustering_method = clustering_method,
          na_col = "grey80")
  return(p)
}

UMAP_density_plot = function(data,
                             ggtitle = "UMAP with disease status labels",
                             legend_name = "Disease status",
                             labels = clin$Condition,
                             file_location = "plots/UMAP_condition.pdf",
                             file_location_labels = "plots/UMAP_condition_labels.pdf",
                             colour_set = c("seagreen4", "slateblue1", "salmon")){
      # run umap function
      umap_out = umap::umap(data)
      umap_plot = as.data.frame(umap_out$layout)

      #add condition labels
      umap_plot$group = labels

      # plot umap
      p1 = ggplot(umap_plot) + geom_point(aes(x=V1, y=V2, color = as.factor(group))) +
        ggtitle(ggtitle) +
          theme_few() +
          scale_colour_few() +
          scale_color_manual(name = legend_name,
                           labels = levels(as.factor(umap_plot$group)),
                           values = colour_set)

      xdens <-
        axis_canvas(p1, axis = "x") +
        geom_density(data = umap_plot, aes(x = V1, fill = group, colour = group), alpha = 0.3) +
        scale_fill_manual( values = colour_set) +
        scale_colour_manual( values = colour_set)
      ydens <-
        axis_canvas(p1, axis = "y", coord_flip = TRUE) +
        geom_density(data = umap_plot, aes(x = V2, fill = group, colour = group), alpha = 0.3) +
        coord_flip() +
        scale_fill_manual(values = colour_set) +
        scale_colour_manual( values = colour_set)
      p1 %>%
        insert_xaxis_grob(xdens, grid::unit(1, "in"), position = "top") %>%
        insert_yaxis_grob(ydens, grid::unit(1, "in"), position = "right") %>%
        ggdraw()

      p1
      # save umap
      ggsave(file_location, width = 11/2, height = 8/2, units = "in")

      p1 + geom_text(label = rownames(umap_plot), x = umap_plot$V1, y = umap_plot$V2,
                     hjust = 0, nudge_x = 1, size = 1.5, colour = "grey")

      # save umap with labels
      ggsave(file_location_labels, width = 11/2, height = 8/2, units = "in")
      return(p1)
}

```

#### - CSF
```{r visualizations-CSF,warning=FALSE,message=FALSE}
## Distribution of expression values per ID and tube number
mean_expression_plot(data = t(assay(lipidomics_data_CSF$se)), 
                      file_sample = "plots/boxplots_expression_each_sample_CSF.pdf",
                      file_mass = "plots/boxplots_expression_each_lipid_CSF.pdf",
                      title = "CSF lipidomics")

## Heatmaps
# CSF
title = "lipidomics CSF" 

data = assay(lipidomics_data_CSF$se)
data_z = t(scale(t(data),center = TRUE,scale = TRUE))
data_z[is.na(data_z)] <- 0

#row annotation
names_lipids = rownames(data)
Lipids_final <- read_excel("data input/RE_ metabolomics/Lipids_final.xlsx")
lipids = Lipids_final %>% 
  select(Name,Class) %>%
  filter(Name %in% names_lipids)
lipids = lipids[match(lipids$Name,names_lipids),]
lipids_overview = lipids %>%
  group_by(Class) %>%
  summarise(n_lipids = n()) %>%
  arrange(desc(n_lipids))
writexl::write_xlsx(lipids_overview,"results/lipids_overview.xlsx")
annotation_row = data.frame(lipid_type = as.factor(lipids$Class))
rownames(annotation_row) = lipids$Name
participant_type = tube_batch_CSF
annotation_col = data.frame(type = as.factor(lipidomics_data_CSF$se$condition))
rownames(annotation_col) = lipidomics_data_CSF$se$ID
annotation_col$type <- factor(
  annotation_col$type,
  levels = c("ALS","PGMC","CTR","mimic","SYMP", "N.A."))
colors_type = c("mediumpurple1", "darksalmon", "yellow4","blue4","seagreen4","orange3")
names(colors_type) = c("ALS","CTR","mimic","N.A.","PGMC","SYMP")
mycolors = colorRampPalette(brewer.pal(9, "Set1"))(length(unique(annotation_row$lipid_type)))
names(mycolors) <- unique(annotation_row$lipid_type)
annotation_colours <- list(
  lipid_type = mycolors,
  type = colors_type)

# order data
row_order <- order(annotation_row$lipid_type)  
col_order <- order(annotation_col$type)
data          <- data[row_order, col_order]
data_z          <- data_z[row_order, col_order]
annotation_row <- annotation_row[row_order, , drop = FALSE]
annotation_col <- annotation_col[col_order, , drop = FALSE]

#without grouping, all lipids, expression data
p = make_pheatmap(data = data, 
                  cluster_cols = F, 
                  main = paste0("Heatmap all lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  #color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_raw_",title,".pdf"))

#without grouping, all lipids, z-score
p = make_pheatmap(data = data_z, 
                  cluster_cols = F, 
                  main = paste0("Heatmap all lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  #color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_zscore_raw_",title,".pdf"))

#without grouping, filtered lipids
data = assay(lipidomics_data_CSF$se_filt_norm)
data_z = t(scale(t(data),center = TRUE,scale = TRUE))
data_z[is.na(data_z)] <- 0

#row annotation
names_lipids = rownames(data)
lipids = Lipids_final %>% 
  select(Name,Class) %>%
  filter(Name %in% names_lipids)
idx <- match(names_lipids, lipids$Name)
keep <- !is.na(idx)
lipids <- lipids[idx[keep], ]
data   <- data[keep, , drop = FALSE]
annotation_row = data.frame(lipid_type = as.factor(lipids$Class))
rownames(annotation_row) = lipids$Name

# order data
row_order <- order(annotation_row$lipid_type)  
data          <- data[row_order, col_order]
data_z          <- data_z[row_order, col_order]
annotation_row <- annotation_row[row_order, , drop = FALSE]

# expression data
p = make_pheatmap(data = data, 
                  cluster_cols = F, 
                  main = paste0("Heatmap filtered lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  #color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_filtered_",title,".pdf"))

# z-score
p = make_pheatmap(data = data_z, 
                  cluster_cols = F, 
                  main = paste0("Heatmap filtered lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  #color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_zscore_filtered_",title,".pdf"))

#without grouping, filtered and imputed
data = assay(lipidomics_data_CSF$se_filt_impute)
data_z = t(scale(t(data),center = TRUE,scale = TRUE))
data_z[is.na(data_z)] <- 0

#row annotation
names_lipids = rownames(data)
lipids = Lipids_final %>% 
  select(Name,Class) %>%
  filter(Name %in% names_lipids)
idx <- match(names_lipids, lipids$Name)
keep <- !is.na(idx)
lipids <- lipids[idx[keep], ]
data   <- data[keep, , drop = FALSE]
annotation_row = data.frame(lipid_type = as.factor(lipids$Class))
rownames(annotation_row) = lipids$Name

# order data
row_order <- order(annotation_row$lipid_type)  
data          <- data[row_order, col_order]
data_z          <- data_z[row_order, col_order]
annotation_row <- annotation_row[row_order, , drop = FALSE]

# expression data
p = make_pheatmap(data = data, 
                  cluster_cols = F, 
                  main = paste0("Heatmap imputed lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  #color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_imputed_",title,".pdf"))

# z-score
p = make_pheatmap(data = data_z, 
                  cluster_cols = F, 
                  main = paste0("Heatmap imputed lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  #color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_zscore_imputed_",title,".pdf"))

# without grouping, 100 most variable lipids
d = assay(lipidomics_data_CSF$se_filt_impute)
d2 = head(order(rowVars(d),decreasing = T),100)
data = d[d2,]
data_z = t(scale(t(data),center = TRUE,scale = TRUE))
data_z[is.na(data_z)] <- 0

#row annotation
names_lipids = rownames(data)
lipids = Lipids_final %>% 
  select(Name,Class) %>%
  filter(Name %in% names_lipids)
idx <- match(names_lipids, lipids$Name)
keep <- !is.na(idx)
lipids <- lipids[idx[keep], ]
data   <- data[keep, , drop = FALSE]
annotation_row = data.frame(lipid_type = as.factor(lipids$Class))
rownames(annotation_row) = lipids$Name

# order data
row_order <- order(annotation_row$lipid_type)  
data          <- data[row_order, col_order] 
data_z          <- data_z[row_order, col_order]
annotation_row <- annotation_row[row_order, , drop = FALSE]

# expression data
p = make_pheatmap(data, 
                  cluster_cols = F, 
                  main = paste0("Heatmap 100 most variable lipids\n",title, "\nnot clustered"),
                  labels_col = colnames(d),
                  #color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_imputed_mostvar_",title,".pdf"))

# z-score
p = make_pheatmap(data_z, 
                  cluster_cols = F, 
                  main = paste0("Heatmap 100 most variable lipids\n",title, "\nnot clustered"),
                  labels_col = colnames(d),
                  color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  #color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_zscore_imputed_mostvar_",title,".pdf"))

## UMAP (with participant status type)
d_CSF = t(assay(lipidomics_data_CSF$se_filt_impute))
labels_group = tube_batch_CSF$type
group = c("mediumpurple1", "darksalmon", "yellow4","blue4","seagreen4","orange3")
UMAP_density_plot(data = d_CSF,
                          ggtitle = paste0("UMAP with type labels\n", title),
                          legend_name = "Fluid labels",
                          labels = labels_group,
                          file_location = paste0("plots/UMAP_type_",title,".pdf"),
                          file_location_labels =paste0("plots/UMAP_type_labels_",title,".pdf"),
                          colour_set = group)

# UMAP (with batch info)
labels_group = tube_batch_CSF$Batch
group = c("#3DB7E4", "#FF8849", "#69BE28")
UMAP_density_plot(data = d_CSF,
                          ggtitle = paste0("UMAP with batch labels\n", title),
                          legend_name = "Fluid labels",
                          labels = labels_group,
                          file_location = paste0("plots/UMAP_batch_",title,".pdf"),
                          file_location_labels =paste0("plots/UMAP_batch_labels_",title,".pdf"),
                          colour_set = group)
```

#### - Plasma 
```{r visualizations-plasma,warning=FALSE,message=FALSE}
## Distribution of expression values per ID and tube number
mean_expression_plot(data = t(assay(lipidomics_data_plasma$se)), 
                      file_sample = "plots/boxplots_expression_each_sample_plasma.pdf",
                      file_mass = "plots/boxplots_expression_each_lipid_plasma.pdf",
                      title = "plasma lipidomics")

## Heatmaps
# plasma
title = "lipidomics plasma" 

data = assay(lipidomics_data_plasma$se)
data_z = t(scale(t(data),center = TRUE,scale = TRUE))
data_z[is.na(data_z)] <- 0

#row annotation
names_lipids = rownames(data)
Lipids_final <- read_excel("data input/RE_ metabolomics/Lipids_final.xlsx")
lipids = Lipids_final %>% 
  select(Name,Class) %>%
  filter(Name %in% names_lipids)
lipids = lipids[match(lipids$Name,names_lipids),]
annotation_row = data.frame(lipid_type = as.factor(lipids$Class))
rownames(annotation_row) = lipids$Name
participant_type = tube_batch_plasma
annotation_col = data.frame(type = as.factor(lipidomics_data_plasma$se$condition))
rownames(annotation_col) = lipidomics_data_plasma$se$ID
annotation_col$type <- factor(
  annotation_col$type,
  levels = c("ALS","PGMC","CTR","mimic","SYMP", "N.A."))
colors_type = c("mediumpurple1", "darksalmon", "yellow4","blue4","seagreen4","orange3")
names(colors_type) = c("ALS","CTR","mimic","N.A.","PGMC","SYMP")
mycolors = colorRampPalette(brewer.pal(9, "Set1"))(length(unique(annotation_row$lipid_type)))
names(mycolors) <- unique(annotation_row$lipid_type)
annotation_colours <- list(
  lipid_type = mycolors,
  type = colors_type)

# order data
row_order <- order(annotation_row$lipid_type)  
col_order <- order(annotation_col$type)
data          <- data[row_order, col_order]
data_z          <- data_z[row_order, col_order]
annotation_row <- annotation_row[row_order, , drop = FALSE]
annotation_col <- annotation_col[col_order, , drop = FALSE]

#without grouping, all lipids, expression data
p = make_pheatmap(data = data, 
                  cluster_cols = F, 
                  main = paste0("Heatmap all lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  #color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_raw_",title,".pdf"))

#without grouping, all lipids, z-score
p = make_pheatmap(data = data_z, 
                  cluster_cols = F, 
                  main = paste0("Heatmap all lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  #color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_zscore_raw_",title,".pdf"))

#without grouping, filtered lipids
data = assay(lipidomics_data_plasma$se_filt_norm)
data_z = t(scale(t(data),center = TRUE,scale = TRUE))
data_z[is.na(data_z)] <- 0

#row annotation
names_lipids = rownames(data)
lipids = Lipids_final %>% 
  select(Name,Class) %>%
  filter(Name %in% names_lipids)
idx <- match(names_lipids, lipids$Name)
keep <- !is.na(idx)
lipids <- lipids[idx[keep], ]
data   <- data[keep, , drop = FALSE]
annotation_row = data.frame(lipid_type = as.factor(lipids$Class))
rownames(annotation_row) = lipids$Name

# order data
row_order <- order(annotation_row$lipid_type)  
data          <- data[row_order, col_order]
data_z          <- data_z[row_order, col_order]
annotation_row <- annotation_row[row_order, , drop = FALSE]

# expression data
p = make_pheatmap(data = data, 
                  cluster_cols = F, 
                  main = paste0("Heatmap filtered lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  #color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_filtered_",title,".pdf"))

# z-score
p = make_pheatmap(data = data_z, 
                  cluster_cols = F, 
                  main = paste0("Heatmap filtered lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  #color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_zscore_filtered_",title,".pdf"))

#without grouping, filtered and imputed
data = assay(lipidomics_data_plasma$se_filt_impute)
data_z = t(scale(t(data),center = TRUE,scale = TRUE))
data_z[is.na(data_z)] <- 0

#row annotation
names_lipids = rownames(data)
lipids = Lipids_final %>% 
  select(Name,Class) %>%
  filter(Name %in% names_lipids)
idx <- match(names_lipids, lipids$Name)
keep <- !is.na(idx)
lipids <- lipids[idx[keep], ]
data   <- data[keep, , drop = FALSE]
annotation_row = data.frame(lipid_type = as.factor(lipids$Class))
rownames(annotation_row) = lipids$Name

# order data
row_order <- order(annotation_row$lipid_type)  
data          <- data[row_order, col_order]
data_z <- data_z[row_order, col_order]
annotation_row <- annotation_row[row_order, , drop = FALSE]

# expression data
p = make_pheatmap(data = data, 
                  cluster_cols = F, 
                  main = paste0("Heatmap imputed lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  #color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_imputed_",title,".pdf"))

# z-score
p = make_pheatmap(data = data_z, 
                  cluster_cols = F, 
                  main = paste0("Heatmap imputed lipids\n",title, "\n not clustered"), 
                  show_rownames = F,
                  labels_col = colnames(data),
                  color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  #color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_zscore_imputed_",title,".pdf"))

# without grouping, 100 most variable lipids
d = assay(lipidomics_data_plasma$se_filt_impute)
d2 = head(order(rowVars(d),decreasing = T),100)
data = d[d2,]
data_z = t(scale(t(data),center = TRUE,scale = TRUE))
data_z[is.na(data_z)] <- 0

#row annotation
names_lipids = rownames(data)
lipids = Lipids_final %>% 
  select(Name,Class) %>%
  filter(Name %in% names_lipids)
idx <- match(names_lipids, lipids$Name)
keep <- !is.na(idx)
lipids <- lipids[idx[keep], ]
data   <- data[keep, , drop = FALSE]
annotation_row = data.frame(lipid_type = as.factor(lipids$Class))
rownames(annotation_row) = lipids$Name

# order data
row_order <- order(annotation_row$lipid_type)  
data          <- data[row_order, col_order]
data_z <- data_z[row_order, col_order]
annotation_row <- annotation_row[row_order, , drop = FALSE]

# expression data
p = make_pheatmap(data, 
                  cluster_cols = F, 
                  main = paste0("Heatmap 100 most variable lipids\n",title, "\nnot clustered"),
                  labels_col = colnames(d),
                  #color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_imputed_mostvar_",title,".pdf"))

# z-score
p = make_pheatmap(data_z, 
                  cluster_cols = F, 
                  main = paste0("Heatmap 100 most variable lipids\n",title, "\nnot clustered"),
                  labels_col = colnames(d),
                  color = colorRampPalette(c("navy", "white", "firebrick3"))(100))
                  #color = viridis::magma(100, direction = -1))
save_pheatmap_pdf(p, filename = paste0("plots/heatmap_zscore_imputed_mostvar_",title,".pdf"))

## UMAP (with participant status type)
d_plasma = t(assay(lipidomics_data_plasma$se_filt_impute))
labels_group = tube_batch_plasma$type
group = c("mediumpurple1", "darksalmon", "yellow4","blue4","seagreen4","orange3")
UMAP_density_plot(data = d_plasma,
                          ggtitle = paste0("UMAP with type labels\n", title),
                          legend_name = "Fluid labels",
                          labels = labels_group,
                          file_location = paste0("plots/UMAP_type_",title,".pdf"),
                          file_location_labels =paste0("plots/UMAP_type_labels_",title,".pdf"),
                          colour_set = group)

# UMAP (with batch info)
labels_group = tube_batch_plasma$Batch
group = c("#3DB7E4", "#FF8849", "#69BE28","#757083","#CF7684","#A0C8C0","#CDAE3B")
UMAP_density_plot(data = d_plasma,
                          ggtitle = paste0("UMAP with batch labels\n", title),
                          legend_name = "Fluid labels",
                          labels = labels_group,
                          file_location = paste0("plots/UMAP_batch_",title,".pdf"),
                          file_location_labels =paste0("plots/UMAP_batch_labels_",title,".pdf"),
                          colour_set = group)

```

- CSF and Plasma together
```{r visualizations-plasma-CSF,warning=FALSE,message=FALSE}
 proteins_in_both_fluids = colnames(d_CSF)[colnames(d_CSF) %in% colnames(d_plasma)]
  
  d_1 = d_CSF[,proteins_in_both_fluids]
  d_2 = d_plasma[,proteins_in_both_fluids]
  
  d = do.call("rbind",list(d_1,d_2))
  
  labels_group = c(rep("CSF", nrow(d_1)), rep("Plasma", nrow(d_2)))
  title = "plasma_vs_CSF"

# UMAP of both biofluids
UMAP_density_plot(data = d,
                  ggtitle = paste0("UMAP with fluid labels\n", title),
                  legend_name = "Fluid labels",
                  labels = labels_group,
                  file_location = paste0("plots/UMAP_fluid_group_lipids_",title,".pdf"),
                  file_location_labels=paste0("plots/UMAP_fluid_group_labels_",title,".pdf"),
                  colour_set = group)

# UMAP of both biofluids - batch corrected

batch_CSF = tube_batch_CSF$Batch
batch_plasma = tube_batch_plasma$Batch
batch = c(batch_CSF,batch_plasma)
fluid = labels_group
design = model.matrix(~fluid)

d_batch_corrected <- limma::removeBatchEffect(t(d), batch = batch, design = design)
d_batch_corrected <- t(d_batch_corrected)

UMAP_density_plot(data = d_batch_corrected,
                  ggtitle = paste0("UMAP with fluid labels (batch corrected)\n", title),
                  legend_name = "Fluid labels",
                  labels = labels_group,
                  file_location = paste0("plots/UMAP_fluid_group_lipids_batch_corrected",title,".pdf"),
                  file_location_labels=paste0("plots/UMAP_fluid_group_labels_batch_corrected",title,".pdf"),
                  colour_set = group)
```

#### Step 8: differential expression analyses

The **eighth step** is to *perform differential expression analyses*, with particular interest of eALS vs CTR, PGMC vs CTR. For this, the information between IDs and the status (eALS, CTR, PGMC, mimic) have to be collected from other datasets 

```{r functions-DEx,warning=FALSE,message=FALSE,echo = FALSE}
# function to run limma for DEX with covariates
run_DEx <- function(
  dep,
  condition_col = "condition",
  covariates = c("sex","batch","age"),
  contrasts = NULL,         
  pairwise = c("vs_ref","all"),
  ref_level = NULL,          # used when pairwise = "vs_ref"
  flip_pairwise = FALSE,     # used only when pairwise = "all"
  robust = TRUE,
  trend = FALSE,
  adjust.method = "BH",
  alpha = NULL,
  use_adjusted_p = TRUE,
  lfc_thresh = NULL
){
  suppressPackageStartupMessages({
    library(limma)
    library(SummarizedExperiment)
    library(S4Vectors)
  })
  pairwise <- match.arg(pairwise)

  if (!inherits(dep, "SummarizedExperiment")) {
    stop("Expected a SummarizedExperiment-like object.")
  }

  expr   <- SummarizedExperiment::assay(dep)
  coldat <- as.data.frame(SummarizedExperiment::colData(dep))

  if (!condition_col %in% names(coldat))
    stop(sprintf("Column '%s' not found in colData().", condition_col))

  covariates <- covariates[covariates %in% names(coldat)]

  # drop NAs in model 
  model_cols <- unique(c(condition_col, covariates))
  keep <- stats::complete.cases(coldat[, model_cols, drop = FALSE])
  if (!all(keep)) {
    message(sprintf("Dropping %d samples with missing values in: %s",
                    sum(!keep), paste(model_cols, collapse=", ")))
  }
  coldat <- coldat[keep, , drop = FALSE]
  expr   <- expr[, keep, drop = FALSE]

  coldat[[condition_col]] <- factor(coldat[[condition_col]])
  for (cv in covariates) {
    x <- coldat[[cv]]
    if (is.character(x) || is.logical(x)) coldat[[cv]] <- factor(x)
  }

  # remoce spaces in the names 
  sanitize_levels <- function(x) { if (is.factor(x)) { levels(x) <- make.names(levels(x)) }; x }
  coldat[[condition_col]] <- sanitize_levels(coldat[[condition_col]])
  for (cv in covariates) coldat[[cv]] <- sanitize_levels(coldat[[cv]])

  # design
  rhs <- paste(c(paste0("0 + ", condition_col), covariates), collapse = " + ")
  design <- stats::model.matrix(as.formula(paste("~", rhs)), data = coldat)
  colnames(design) <- make.names(colnames(design))  

  # model
  fit <- limma::lmFit(expr, design)

  cond_levels <- levels(coldat[[condition_col]])

  make_all_pairwise <- function(levels, pref, flip = FALSE) {
    out <- character()
    if (length(levels) < 2) return(out)
    for (i in seq_len(length(levels) - 1)) {
      for (j in (i + 1):length(levels)) {
        if (!flip) {
          nm  <- paste(levels[i], "vs", levels[j], sep = "_")
          exp <- paste0(pref, levels[i], " - ", pref, levels[j])
        } else {
          nm  <- paste(levels[j], "vs", levels[i], sep = "_")
          exp <- paste0(pref, levels[j], " - ", pref, levels[i])
        }
        out[nm] <- exp
      }
    }
    out
  }

  make_vs_ref <- function(levels, pref, ref) {
    if (is.null(ref)) stop("Provide 'ref_level' when pairwise='vs_ref'.")
    if (!(ref %in% levels)) stop(sprintf("ref_level '%s' not found in levels(%s).", ref, condition_col))
    others <- setdiff(levels, ref)
    setNames(
      object = paste0(pref, others, " - ", pref, ref),
      nm     = paste0(others, "_vs_", ref)
    )
  }

  if (is.null(contrasts)) {
    if (pairwise == "vs_ref") {
      contrasts <- make_vs_ref(cond_levels, paste0(condition_col), ref_level)
    } else {
      contrasts <- make_all_pairwise(cond_levels, paste0(condition_col), flip = flip_pairwise)
    }
  }

  coefs_in_design <- colnames(design)
  normalize_terms <- function(cterm) {
    toks <- unlist(strsplit(cterm, "([\\+\\-])", perl=TRUE))
    toks <- trimws(toks)
    ops  <- gsub("[^\\+\\-]", "", unlist(strsplit(cterm, "[^\\+\\-]+", perl=TRUE)))
    ops  <- ops[ops != ""]
    repl <- function(tok){
      if (tok %in% coefs_in_design) return(tok)
      cand <- make.names(paste0(condition_col, tok))
      if (cand %in% coefs_in_design) return(cand)
      stop(sprintf("Contrast term '%s' not found in design columns.", tok))
    }
    toks2 <- vapply(toks, repl, character(1))
    out <- toks2[1]
    if (length(ops)) for (k in seq_along(ops)) out <- paste0(out, ops[k], toks2[k+1])
    out
  }
  contrasts_norm <- vapply(contrasts, normalize_terms, character(1))
  Cmat <- limma::makeContrasts(contrasts = contrasts_norm, levels = design)

  fit2 <- limma::contrasts.fit(fit, Cmat)
  fit2 <- limma::eBayes(fit2, robust = robust, trend = trend)

  fmeta <- as.data.frame(SummarizedExperiment::rowData(dep))
  fmeta$feature_id <- rownames(expr)
  tables <- setNames(vector("list", ncol(Cmat)), colnames(Cmat))

  for (cf in colnames(Cmat)) {
    tt <- limma::topTable(fit2, coef = cf, number = Inf, sort.by = "P", adjust.method = adjust.method)
    tt$feature_id <- rownames(tt)

    if (!is.null(alpha) || !is.null(lfc_thresh)) {
      pcol <- if (use_adjusted_p) "adj.P.Val" else "P.Value"
      sigp <- if (!is.null(alpha)) tt[[pcol]] < alpha else TRUE
      sigf <- if (!is.null(lfc_thresh)) abs(tt$logFC) >= lfc_thresh else TRUE
      tt$significant <- sigp & sigf
    }

    if (nrow(fmeta)) {
      tt <- merge(fmeta, tt, by = "feature_id", all.y = TRUE)
      rownames(tt) <- tt$feature_id
    }
    tables[[cf]] <- tt
  }

  combined <- do.call(rbind, Map(function(d, n){d$contrast <- n; d}, tables, names(tables)))
  rownames(combined) <- NULL

  list(design = design, contrast_matrix = Cmat, fit = fit2, tables = tables, combined = combined)
}

# DEx per visit
run_DEx_visit <- function(se, visit_value, ...) {
  keep <- !is.na(colData(se)$Visit) & colData(se)$Visit == visit_value
  se_sub <- se[, keep, drop = FALSE]

  run_DEx(
    se_sub,
    covariates = c("sex","batch","age"),
    contrasts = c(
      "PGMC_vs_CTR"   = "PGMC-CTR",
      "ALS_vs_CTR"    = "ALS-CTR",
      "mimic_vs_CTR"  = "mimic-CTR",
      "ALS_vs_PGMC"   = "ALS-PGMC",
      "ALS_vs_mimic"  = "ALS-mimic",
      "mimic_vs_PGMC" = "mimic-PGMC"
    )
  )
}

# summarise DEx results
summarise_DE <- function(res, key = "name") {
  contrast_map <- c(
    ALS_CTR   = "conditionALS-conditionCTR",
    PGMC_CTR  = "conditionPGMC-conditionCTR",
    mimic_CTR = "conditionmimic-conditionCTR",
    ALS_PGMC  = "conditionALS-conditionPGMC",
    ALS_mimic = "conditionALS-conditionmimic",
    mimic_PGMC= "conditionmimic-conditionPGMC"
  )
  
  dfs <- lapply(names(contrast_map), function(short) {
    tab_name <- contrast_map[[short]]
    tab <- res$tables[[tab_name]]
    
    tab %>%
      dplyr::select(all_of(c(key, "logFC", "P.Value", "adj.P.Val"))) %>%
      dplyr::rename(
        !!paste0("logFC_", short)      := logFC,
        !!paste0("P.Value_", short)    := P.Value,
        !!paste0("adj.P.Val_", short)  := adj.P.Val
      )
  })
  
  Reduce(function(x, y) merge(x, y, by = key, all = TRUE), dfs)
}

# volcano plot
volcano_plot_contrast <- function(
  df,
  log2fc_col,
  padj_col,
  group_pos,
  group_neg,
  title = NULL,
  de_col   = "DE",
  label_col = "Target",
  alpha = NULL,
  colors = NULL,
  add_x = 0,
  add_y = 0
){
  # create DE column 
  if (!de_col %in% names(df)) {
    df <- df %>%
      mutate(
        !!de_col := case_when(
          .data[[log2fc_col]] >  0 &  .data[[padj_col]] < alpha ~ group_pos,
          .data[[log2fc_col]] <  0 & .data[[padj_col]] < alpha ~ group_neg,
          TRUE                      ~ "ns"
        )
      )
  }

  # -log10(padj) 
  df <- df %>% mutate(`.minus_log10_padj` = -log10(.data[[padj_col]]))

  if (is.null(colors)) {
    colors <- c(
      setNames("#3da0c2", group_pos),   # pos side
      ns = "lightgrey",
      setNames("#C25F3D", group_neg)    # neg side
    )
  }

  p <- ggplot(df, aes(x = .data[[log2fc_col]], y = .minus_log10_padj)) +
    geom_point(aes(color = .data[[de_col]], size = .minus_log10_padj), alpha = 0.8) +
    geom_text_repel(
      data = df %>% filter(.data[[de_col]] != "ns"),
      aes(label = .data[[label_col]]),
      max.overlaps = 20,
      box.padding = 0.4,
      size = 5
    ) +
    geom_vline(xintercept = 0, linetype = "dashed", col = "darkgrey")

  if (!is.null(alpha)) {
    p <- p +
      geom_hline(yintercept = -log10(alpha), linetype = "dashed", col = "darkgrey") +
      annotate("text", x = add_x, y = (-log10(alpha)) + add_y,
               label = paste0("FDR = ", alpha*100," %"), size = 5, col = "darkgrey")
  }

  p +
    scale_color_manual(values = colors) +
    scale_size_continuous(range = c(2, 7)) +
    theme_minimal() +
    ylab(expression(-log[10]("adjusted p-value"))) +
    xlab(expression(log[2]("fold-change"))) +
    ggtitle(title) +
    labs(size = expression(-log[10]("adjusted p-value"))) +
    theme(
      axis.title.x = element_blank(),
      text = element_text(size = 15),
      axis.title = element_text(size = 18),
      axis.text = element_text(size = 16),
      plot.title = element_text(size = 18, hjust = 0.5, face = "bold"),
      legend.title = element_text(size = 16),
      legend.text = element_text(size = 15)
    )
}

# make new Design Experiments column data with info of sex and age
# - CSF
coldata_CSF = as.data.frame(colData(lipidomics_data_CSF$se_filt_impute))
coldata_CSF_new = coldata_CSF %>% 
  mutate(PatientID = tube_batch_CSF$PatientID,
         Visit = tube_batch_CSF$Visit) %>%
  mutate(PatientID = ifelse(is.na(PatientID),"6H1HR8R7",PatientID)) %>%
  left_join(date_all %>% dplyr::select(Pseudonyme,age) %>% dplyr::rename(PatientID = Pseudonyme)) %>%
  left_join(Sex_all %>% dplyr::select(Pseudonyme,sex) %>% dplyr::rename(PatientID = Pseudonyme)) 
colData(lipidomics_data_CSF$se_filt_impute) = S4Vectors::DataFrame(coldata_CSF_new)

# run for each visit
res_CSF_V0 <- run_DEx_visit(lipidomics_data_CSF$se_filt_impute, "V0")
res_CSF_V1 <- run_DEx_visit(lipidomics_data_CSF$se_filt_impute, "V1")

# summarise for each visit
res_CSF_V0_all <- summarise_DE(res_CSF_V0, key = "name")
res_CSF_V1_all <- summarise_DE(res_CSF_V1, key = "name")

writexl::write_xlsx(list(DE_CSF_V0 = res_CSF_V0_all, DE_CSF_V1 = res_CSF_V1_all),
                    "results/DE_CSF_by_visit.xlsx")

# - Plasma
coldata_plasma = as.data.frame(colData(lipidomics_data_plasma$se_filt_impute))
coldata_plasma_new = coldata_plasma %>% 
  mutate(PatientID = tube_batch_plasma$PatientID,
         Visit = tube_batch_plasma$Visit) %>%
  mutate(PatientID = ifelse(is.na(PatientID),"6H1HR8R7",PatientID)) %>%
  left_join(date_all %>% dplyr::select(Pseudonyme,age) %>% dplyr::rename(PatientID = Pseudonyme)) %>%
  left_join(Sex_all %>% dplyr::select(Pseudonyme,sex) %>% dplyr::rename(PatientID = Pseudonyme)) 
colData(lipidomics_data_plasma$se_filt_impute) = S4Vectors::DataFrame(coldata_plasma_new)

# run for each visit
res_plasma_V0 <- run_DEx_visit(lipidomics_data_plasma$se_filt_impute, "V0")
res_plasma_V1 <- run_DEx_visit(lipidomics_data_plasma$se_filt_impute, "V1")

# summarise for each visit
res_plasma_V0_all <- summarise_DE(res_plasma_V0, key = "name")
res_plasma_V1_all <- summarise_DE(res_plasma_V1, key = "name")

writexl::write_xlsx(list(DE_plasma_V0 = res_plasma_V0_all, DE_plasma_V1 = res_plasma_V1_all),
                    "results/DE_plasma_by_visit.xlsx")


```

- CSF
```{r functions-DEx-CSF,warning=FALSE,message=FALSE}
# ALS vs CTR
p = volcano_plot_contrast(res_CSF_V0_all,
                      log2fc_col = "logFC_ALS_CTR",
                      padj_col   = "adj.P.Val_ALS_CTR",
                      group_pos  = "ALS",
                      group_neg  = "CTR",
                      title      = "ALS vs CTR at V0 (FDR = 10%)",
                      label_col = "name",
                      alpha      = 0.1,      
                      add_x      = 0.65, add_y = 0.05)
p
pdf("plots/DE_CSF_V0_ALS_CTR_FDR10.pdf",width = 12,height = 8)
p
dev.off()

p = volcano_plot_contrast(res_CSF_V1_all,
                      log2fc_col = "logFC_ALS_CTR",
                      padj_col   = "adj.P.Val_ALS_CTR",
                      group_pos  = "ALS",
                      group_neg  = "CTR",
                      title      = "ALS vs CTR at V1 (FDR = 10%)",
                      label_col = "name",
                      alpha      = 0.1,      
                      add_x      = 1.2, add_y = 0.05)
p
pdf("plots/DE_CSF_V1_ALS_CTR_FDR10.pdf",width = 12,height = 8)
p
dev.off()


# PGMC vs CTR
p = volcano_plot_contrast(res_CSF_V0_all,
                      log2fc_col = "logFC_PGMC_CTR",
                      padj_col   = "adj.P.Val_PGMC_CTR",
                      group_pos  = "PGMC",
                      group_neg  = "CTR",
                      title      = "PGMC vs CTR at V0 (FDR = 10%)",
                      label_col = "name",
                      alpha      = 0.1,      
                      add_x      = 0.9, add_y = 0.05)
p
pdf("plots/DE_CSF_V0_PGMC_CTR_FDR10.pdf",width = 12,height = 8)
p
dev.off()

p = volcano_plot_contrast(res_CSF_V1_all,
                      log2fc_col = "logFC_PGMC_CTR",
                      padj_col   = "adj.P.Val_PGMC_CTR",
                      group_pos  = "PGMC",
                      group_neg  = "CTR",
                      title      = "PGMC vs CTR at V1 (FDR = 10%)",
                      label_col = "name",
                      alpha      = 0.1,      
                      add_x      = 0.7, add_y = 0.05)
p
pdf("plots/DE_CSF_V1_PGMC_CTR_FDR10.pdf",width = 12,height = 8)
p
dev.off()
```

- Plasma
```{r functions-DEx-plasma,warning=FALSE,message=FALSE}
# ALS vs CTR
p = volcano_plot_contrast(res_plasma_V0_all,
                      log2fc_col = "logFC_ALS_CTR",
                      padj_col   = "adj.P.Val_ALS_CTR",
                      group_pos  = "ALS",
                      group_neg  = "CTR",
                      title      = "ALS vs CTR at V0 (FDR = 10%)",
                      label_col = "name",
                      alpha      = 0.1,      
                      add_x      = 0.5, add_y = 0.1)
p
pdf("plots/DE_plasma_V0_ALS_CTR_FDR10.pdf",width = 12,height = 8)
p
dev.off()

p = volcano_plot_contrast(res_plasma_V1_all,
                      log2fc_col = "logFC_ALS_CTR",
                      padj_col   = "adj.P.Val_ALS_CTR",
                      group_pos  = "ALS",
                      group_neg  = "CTR",
                      title      = "ALS vs CTR at V1 (FDR = 5%)",
                      label_col = "name",
                      alpha      = 0.05,      
                      add_x      = 0.7, add_y = 0.1)
p
pdf("plots/DE_plasma_V1_ALS_CTR_FDR5.pdf",width = 12,height = 8)
p
dev.off()

p = volcano_plot_contrast(res_plasma_V1_all,
                      log2fc_col = "logFC_ALS_CTR",
                      padj_col   = "adj.P.Val_ALS_CTR",
                      group_pos  = "ALS",
                      group_neg  = "CTR",
                      title      = "ALS vs CTR at V1 (FDR = 10%)",
                      label_col = "name",
                      alpha      = 0.1,      
                      add_x      = 0.7, add_y = 0.1)
p
pdf("plots/DE_plasma_V1_ALS_CTR_FDR10.pdf",width = 12,height = 8)
p
dev.off()


# PGMC vs CTR
p = volcano_plot_contrast(res_plasma_V0_all,
                      log2fc_col = "logFC_PGMC_CTR",
                      padj_col   = "adj.P.Val_PGMC_CTR",
                      group_pos  = "PGMC",
                      group_neg  = "CTR",
                      title      = "PGMC vs CTR at V0 (FDR = 5%)",
                      label_col = "name",
                      alpha      = 0.05,      
                      add_x      = 0.7, add_y = 0.1)
p
pdf("plots/DE_plasma_V0_PGMC_CTR_FDR5.pdf",width = 12,height = 8)
p
dev.off()
p = volcano_plot_contrast(res_plasma_V0_all,
                      log2fc_col = "logFC_PGMC_CTR",
                      padj_col   = "adj.P.Val_PGMC_CTR",
                      group_pos  = "PGMC",
                      group_neg  = "CTR",
                      title      = "PGMC vs CTR at V0 (FDR = 10%)",
                      label_col = "name",
                      alpha      = 0.1,      
                      add_x      = 0.7, add_y = 0.1)
p
pdf("plots/DE_plasma_V0_PGMC_CTR_FDR10.pdf",width = 12,height = 8)
p
dev.off()

p = volcano_plot_contrast(res_plasma_V1_all,
                      log2fc_col = "logFC_PGMC_CTR",
                      padj_col   = "adj.P.Val_PGMC_CTR",
                      group_pos  = "PGMC",
                      group_neg  = "CTR",
                      title      = "PGMC vs CTR at V1 (FDR = 10%)",
                      label_col = "name",
                      alpha      = 0.1,      
                      add_x      = 0.9, add_y = -0.1)
p
pdf("plots/DE_plasma_V1_PGMC_CTR_FDR10.pdf",width = 12,height = 8)
p
dev.off()

```

